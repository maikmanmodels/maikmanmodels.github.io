<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Maikman Models Stock</title>

<style>
:root{
  --bg:#0f172a;--card:#020617;--text:#e5e7eb;--accent:#38bdf8;
}
body.light{
  --bg:#f1f5f9;--card:#fff;--text:#020617;--accent:#2563eb;
}
*{box-sizing:border-box;transition:.25s}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}

header{
  padding:20px;display:flex;justify-content:space-between;
  align-items:center;font-size:22px;font-weight:bold;
}

button{
  background:var(--accent);border:none;padding:8px 14px;
  border-radius:6px;color:#fff;cursor:pointer
}

input{padding:8px;border-radius:6px;border:none;width:100%}

#login{
  max-width:320px;margin:80px auto;background:var(--card);
  padding:20px;border-radius:12px
}

#app{display:none}

#controls{
  display:flex;gap:10px;padding:20px;flex-wrap:wrap
}

#grid{
  display:grid;gap:16px;padding:20px
}

.card{
  background:var(--card);border-radius:12px;padding:12px;position:relative
}

.card img{
  width:100%;height:200px;object-fit:cover;border-radius:8px
}

.badge{
  position:absolute;bottom:8px;right:8px;
  background:red;color:white;font-size:12px;
  width:22px;height:22px;border-radius:50%;
  display:flex;align-items:center;justify-content:center
}

.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center
}

.modal-content{
  background:var(--card);padding:20px;width:360px;
  border-radius:12px;display:flex;flex-direction:column;gap:10px
}
</style>
</head>

<body>

<div id="login">
  <h2>Acceso</h2>
  <input id="email" type="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="ContraseÃ±a"><br><br>
  <button onclick="login()">Entrar</button>
  <p id="error" style="color:red"></p>
</div>

<div id="app">
<header>
  ğŸ“¦ Maikman Models
  <div>
    <button onclick="toggleTheme()">ğŸŒ“</button>
    <button onclick="openSettings()">âš™ï¸</button>
    <button onclick="logout()">Salir</button>
  </div>
</header>

<div id="controls">
  <input id="search" placeholder="Buscar">
  <button onclick="openModal()">â• AÃ±adir modelo</button>
</div>

<div id="grid"></div>
</div>

<!-- MODALES -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Modelo</h3>
    <input id="codigo" placeholder="CÃ³digo">
    <input id="fabricante" placeholder="Fabricante">
    <input id="modelo" placeholder="Modelo">
    <input id="fotoURL" placeholder="URL imagen">
    <button onclick="guardarModelo()">Guardar</button>
    <button onclick="closeModal()">Cancelar</button>
  </div>
</div>

<div id="paintModal" class="modal">
  <div class="modal-content">
    <h3>Pinturas Tamiya</h3>
    <input id="paintInput" placeholder="x1, xf2, ts30">
    <button onclick="guardarPinturas()">Guardar</button>
    <button onclick="closePaint()">Cerrar</button>
  </div>
</div>

<div id="settings" class="modal">
  <div class="modal-content">
    <h3>Ajustes</h3>
    <label>Tarjetas por fila (PC)</label>
    <input id="cols" type="number" min="1" max="6">
    <button onclick="exportCSV()">Exportar CSV</button>
    <button onclick="closeSettings()">Cerrar</button>
  </div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {getAuth,signInWithEmailAndPassword,onAuthStateChanged,signOut}
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {getFirestore,collection,addDoc,getDocs,updateDoc,deleteDoc,doc}
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyAtWLxQfVqsEt8fLZkGRN-3zSHuzKMUTk8",
  authDomain:"maikmanmodelsstock.firebaseapp.com",
  projectId:"maikmanmodelsstock",
  storageBucket:"maikmanmodelsstock.appspot.com",
  messagingSenderId:"871520809912",
  appId:"1:871520809912:web:4042f15ef200832a95d54d"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let modelos=[],editId=null,paintId=null;

const grid=document.getElementById("grid");
const search=document.getElementById("search");

/* AUTH */
window.login=()=>signInWithEmailAndPassword(auth,email.value,password.value)
.catch(()=>error.textContent="Credenciales incorrectas");

window.logout=()=>signOut(auth);

onAuthStateChanged(auth,u=>{
  login.style.display=u?"none":"block";
  app.style.display=u?"block":"none";
  if(u)cargar();
});

/* UI */
window.toggleTheme=()=>document.body.classList.toggle("light");

/* GRID RESPONSIVE */
function ajustarGrid(){
  if(innerWidth<768) grid.style.gridTemplateColumns="1fr";
  else{
    const c=localStorage.cols||3;
    grid.style.gridTemplateColumns=`repeat(${c},1fr)`;
  }
}
window.onresize=ajustarGrid;

/* DATA */
async function cargar(){
  modelos=[];
  const s=await getDocs(collection(db,"modelos"));
  s.forEach(d=>modelos.push({id:d.id,...d.data()}));
  pintar();
  ajustarGrid();
}

function pintar(){
  grid.innerHTML="";
  modelos.filter(m=>
    (m.modelo||"").toLowerCase().includes(search.value.toLowerCase())
  ).forEach(m=>{
    grid.innerHTML+=`
    <div class="card">
      ${m.dup>1?`<div class="badge">${m.dup}</div>`:""}
      <img src="${m.foto||''}">
      <b>${m.modelo}</b><br>
      <small>${m.fabricante} Â· ${m.codigo}</small><br><br>
      <button onclick='editar(${JSON.stringify(m)})'>âœï¸</button>
      <button onclick='pinturas("${m.id}")'>ğŸ¨</button>
      <button onclick='borrar("${m.id}")'>ğŸ—‘ï¸</button>
    </div>`;
  });
}

/* DUPLICADOS */
function esDuplicado(data){
  return modelos.find(m=>
    m.codigo===data.codigo &&
    m.fabricante===data.fabricante &&
    m.modelo===data.modelo
  );
}

/* SAVE */
window.guardarModelo=async()=>{
  const data={
    codigo:codigo.value,
    fabricante:fabricante.value,
    modelo:modelo.value,
    foto:fotoURL.value,
    dup:1,
    pinturas:[]
  };

  const d=esDuplicado(data);
  if(d && !editHighlight){
    if(!confirm("Modelo duplicado Â¿aÃ±adir?"))return;
    await updateDoc(doc(db,"modelos",d.id),{dup:(d.dup||1)+1});
    closeModal();cargar();return;
  }

  editId
    ? await updateDoc(doc(db,"modelos",editId),data)
    : await addDoc(collection(db,"modelos"),data);

  closeModal();cargar();
};

/* PINTURAS */
window.pinturas=id=>{
  paintId=id;
  const m=modelos.find(x=>x.id===id);
  paintInput.value=(m.pinturas||[]).join(", ");
  paintModal.style.display="flex";
};

window.guardarPinturas=async()=>{
  let arr=[...new Set(
    paintInput.value.split(",")
    .map(p=>p.trim().toUpperCase().replace(/[^A-Z0-9]/g,""))
    .filter(p=>/^(X|XF|LP|TS)\d+$/.test(p))
    .map(p=>p.replace(/([A-Z]+)(\d+)/,"$1-$2"))
  )];
  await updateDoc(doc(db,"modelos",paintId),{pinturas:arr});
  closePaint();cargar();
};

/* SETTINGS */
window.openSettings=()=>settings.style.display="flex";
window.closeSettings=()=>settings.style.display="none";
cols.onchange=()=>{
  localStorage.cols=cols.value;
  ajustarGrid();
};

window.exportCSV=()=>{
  let csv="CÃ³digo,Fabricante,Modelo,Pinturas\n";
  modelos.forEach(m=>{
    csv+=`${m.codigo},${m.fabricante},${m.modelo},"${(m.pinturas||[]).join(" ")}"\n`;
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="maikman_models.csv";
  a.click();
};

/* OTROS */
window.editar=m=>{editId=m.id;openModal(m)};
window.borrar=async id=>{
  if(confirm("Â¿Eliminar modelo?")){
    await deleteDoc(doc(db,"modelos",id));cargar();
  }
};
window.openModal=m=>{
  modal.style.display="flex";
  modalTitle.textContent=m?"Editar":"Nuevo";
  codigo.value=m?.codigo||"";
  fabricante.value=m?.fabricante||"";
  modelo.value=m?.modelo||"";
  fotoURL.value=m?.foto||"";
  editId=m?.id||null;
};
window.closeModal=()=>modal.style.display="none";
window.closePaint=()=>paintModal.style.display="none";

search.oninput=pintar;
</script>

</body>
</html>
