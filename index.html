<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Maikman Models Stock</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* Tu CSS completo - sin cambios */
:root {
--bg:#0f172a; --card:#020617; --text:#e5e7eb; --accent:#38bdf8;
--min-card-width: 260px;
}
body.light {
--bg:#f1f5f9; --card:#fff; --text:#020617; --accent:#2563eb;
}
* { box-sizing:border-box; transition:.3s; }
body { margin:0; font-family:system-ui; background:var(--bg); color:var(--text); }
header { padding:20px; display:flex; justify-content:space-between; align-items:center; font-size:22px; font-weight:bold; }
button { background:var(--accent); border:none; padding:8px 14px; border-radius:6px; cursor:pointer; color:white; }
input { padding:8px; border-radius:6px; border:none; width:100%; }
#login { max-width:320px; margin:80px auto; background:var(--card); padding:20px; border-radius:12px; }
#app { display:none; }
#controls { display:flex; gap:10px; padding:20px; }
#grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(var(--min-card-width),1fr)); gap:16px; padding:20px; }
.card { background:var(--card); border-radius:12px; padding:12px; position:relative; }
.card img { width:100%; height:200px; object-fit:cover; border-radius:8px; }
.card .buttons { display:flex; gap:14px; margin-top:12px; flex-wrap:wrap; }
.badge { position:absolute; bottom:8px; right:8px; background:#dc2626; color:white; border-radius:50%; width:28px; height:28px; display:flex; align-items:center; justify-content:center; font-weight:bold; }
.modal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:1000; }
.modal-content { background:var(--card); padding:24px; width:90%; max-width:400px; border-radius:12px; display:flex; flex-direction:column; gap:12px; max-height:90vh; overflow-y:auto; }
#paintsModal .modal-content { max-width:1400px; }
#paintsList { display:flex; flex-wrap:wrap; gap:32px; margin:20px 0; }
.paints-column { flex:1; min-width:240px; display:flex; flex-direction:column; gap:10px; }
.paints-item { display:flex; align-items:center; gap:12px; padding:8px; border-radius:6px; background:rgba(255,255,255,0.06); font-size:14px; }
.paints-item button { background:none; border:none; color:#ef4444; font-weight:bold; cursor:pointer; font-size:18px; padding:0 8px; }
.paints-color { width:28px; height:28px; border:1px solid #4b5563; border-radius:6px; flex-shrink:0; }
#infoModal .modal-content { max-width:700px; }
#infoGallery { display:flex; flex-wrap:wrap; gap:16px; margin-top:16px; }
#infoGallery img { width:180px; height:180px; object-fit:cover; border-radius:8px; border:1px solid #444; cursor:pointer; }
#configModal .modal-content { width:420px; }
#configModal h4 { margin:20px 0 10px; font-size:18px; }
#configModal label { display:block; margin-bottom:12px; }
#configModal input[type="number"] { width:90px; padding:6px; }
</style>
</head>
<body>

<!-- Tu HTML completo de login, app, modales... -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAtWLxQfVqsEt8fLZkGRN-3zSHuzKMUTk8",
  authDomain: "maikmanmodelsstock.firebaseapp.com",
  projectId: "maikmanmodelsstock",
  storageBucket: "maikmanmodelsstock.appspot.com",
  messagingSenderId: "871520809912",
  appId: "1:871520809912:web:4042f15ef200832a95d54d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const loginBox = document.getElementById("login");
const appBox = document.getElementById("app");
const modal = document.getElementById("modal");
const paintsModal = document.getElementById("paintsModal");
const infoModal = document.getElementById("infoModal");
const configModal = document.getElementById("configModal");
const grid = document.getElementById("grid");
const search = document.getElementById("search");

let modelos = [];
let editId = null;
let currentModel = null;

let itemsPerColumn = parseInt(localStorage.getItem('itemsPerColumn')) || 10;
let cardsPerRow = parseInt(localStorage.getItem('cardsPerRow')) || 4;

// Diccionarios y mapas (definidos lo más arriba posible)
const gunzeToTamiya = { /* tu mapa completo aquí */ };
const tamiyaToGunze = {};
for (const [g, t] of Object.entries(gunzeToTamiya)) tamiyaToGunze[t] = g;

const paintsDict = { /* tu diccionario completo aquí */ };

// ────────────────────────────────────────────────
// applyConfig - segura y con comprobaciones
function applyConfig() {
  document.documentElement.style.setProperty('--min-card-width', `calc((100% - 40px) / ${cardsPerRow} - 16px)`);
  const theme = localStorage.getItem('theme') || 'dark';
  document.body.classList.toggle('light', theme === 'light');
  const currentThemeEl = document.getElementById('currentTheme');
  if (currentThemeEl) {
    currentThemeEl.innerText = theme === 'light' ? 'Claro' : 'Oscuro';
  }
}

// Todo el código que toca el DOM dentro de DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
  applyConfig();

  // Si necesitas listeners adicionales en elementos que pueden no existir al inicio
  const passwordInput = document.getElementById('password');
  if (passwordInput) {
    passwordInput.addEventListener('input', () => { /* si necesitas algo */ });
  }
});

// ────────────────────────────────────────────────
/* LOGIN */
window.login = () => signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value)
  .catch(() => document.getElementById('error').innerText = "Credenciales incorrectas");

window.logout = () => signOut(auth);

onAuthStateChanged(auth, user => {
  if (loginBox) loginBox.style.display = user ? "none" : "block";
  if (appBox) appBox.style.display = user ? "block" : "none";
  if (user) cargarModelos();
});

/* UI */
window.toggleTheme = () => {
  document.body.classList.toggle("light");
  localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
  const currentThemeEl = document.getElementById('currentTheme');
  if (currentThemeEl) {
    currentThemeEl.innerText = document.body.classList.contains('light') ? 'Claro' : 'Oscuro';
  }
};

window.verPassword = () => {
  const pw = document.getElementById('password');
  if (pw) pw.type = pw.type === "password" ? "text" : "password";
};

/* CONFIG */
window.openConfigModal = () => {
  if (configModal) configModal.style.display = 'flex';
  const cardsInput = document.getElementById('configCardsPerRow');
  const itemsInput = document.getElementById('configItemsPerColumn');
  if (cardsInput) cardsInput.value = cardsPerRow;
  if (itemsInput) itemsInput.value = itemsPerColumn;
};

window.closeConfigModal = () => {
  if (configModal) configModal.style.display = 'none';
};

window.saveConfig = () => {
  const cardsInput = document.getElementById('configCardsPerRow');
  const itemsInput = document.getElementById('configItemsPerColumn');
  if (cardsInput) cardsPerRow = Math.max(1, Math.min(8, parseInt(cardsInput.value) || 4));
  if (itemsInput) itemsPerColumn = Math.max(5, Math.min(30, parseInt(itemsInput.value) || 10));
  localStorage.setItem('cardsPerRow', cardsPerRow);
  localStorage.setItem('itemsPerColumn', itemsPerColumn);
  applyConfig();
  closeConfigModal();
  pintar();
};

/* Resto del código (modales, pintar, guardarModelo, etc.) igual que antes */
window.openModal = m => {
  if (modal) modal.style.display = "flex";
  document.getElementById('modalTitle').innerText = m ? "Editar modelo" : "Nuevo modelo";
  document.getElementById('codigo').value = m?.codigo || "";
  document.getElementById('fabricante').value = m?.fabricante || "";
  document.getElementById('modelo').value = m?.modelo || "";
  document.getElementById('precio').value = m?.precio || "";
  document.getElementById('fotoURL').value = "";
  document.getElementById('fotoFile').value = "";
  document.getElementById('galeriaURLs').value = m?.galeria ? m.galeria.join(', ') : "";
  document.getElementById('galeriaFiles').value = "";
  editId = m?.id || null;
};

window.closeModal = () => {
  if (modal) modal.style.display = "none";
};

/* ... resto del código (openInfoModal, openPaintsModal, renderPaintsList, normalizeCode, cargarModelos, pintar, guardarModelo, borrar, exportarModelos, importarModelos) igual que en tu versión anterior */
</script>
</body>
</html>
