<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Maikman Models</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{--cols:3}
body{font-family:sans-serif;margin:0;background:#f4f4f4}
body.dark{background:#121212;color:#eee}
header{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:#222;color:#fff}
button{cursor:pointer;padding:.5rem 1rem}
#models{display:grid;grid-template-columns:repeat(var(--cols),1fr);gap:1rem;padding:1rem}
.card{background:#fff;padding:1rem;border-radius:10px}
body.dark .card{background:#1e1e1e}
img{width:100%;border-radius:6px}
.modal{display:none;position:fixed;inset:0;background:#0008;align-items:center;justify-content:center}
.modal-content{background:#fff;padding:1rem;border-radius:10px;min-width:300px}
body.dark .modal-content{background:#222;color:#fff}
input,select{width:100%;margin:.3rem 0;padding:.4rem}
</style>
</head>

<body>

<header>
<h2>Maikman Models</h2>
<div>
<button onclick="abrirConfig()">âš™ï¸</button>
<button onclick="logout()">Salir</button>
</div>
</header>

<div style="padding:1rem">
<input id="search" placeholder="Buscar modelo, fabricante o cÃ³digo">
<button onclick="nuevo()">â• AÃ±adir modelo</button>
<button onclick="scan()">ğŸ“· Escanear</button>
</div>

<div id="models"></div>

<!-- MODAL MODELO -->
<div id="modal" class="modal">
<div class="modal-content">
<h3>Modelo</h3>
<input id="codigo" placeholder="CÃ³digo / EAN">
<input id="fabricante" placeholder="Fabricante">
<input id="modelo" placeholder="Modelo">
<input id="escala" placeholder="Escala">
<input id="imgurl" placeholder="URL imagen">
<input type="file" id="imgfile">
<button onclick="buscarScalemates()">ğŸ” Buscar en Scalemates</button>
<br><br>
<button onclick="guardar()">ğŸ’¾ Guardar</button>
<button onclick="cerrar()">Cancelar</button>
</div>
</div>

<!-- CONFIG -->
<div id="config" class="modal">
<div class="modal-content">
<h3>ConfiguraciÃ³n</h3>
<button onclick="toggleTheme()">ğŸŒ— Tema</button>
<select id="cols" onchange="setCols()">
<option>2</option><option>3</option><option>4</option><option>5</option>
</select>
<br><br>
<button onclick="cerrarConfig()">Cerrar</button>
</div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {getAuth,onAuthStateChanged,signOut} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {getFirestore,collection,getDocs,addDoc,deleteDoc,doc} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyAtWLxQfVqsEt8fLZkGRN-3zSHuzKMUTk8",
 authDomain:"maikmanmodelsstock.firebaseapp.com",
 projectId:"maikmanmodelsstock"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let data=[];

onAuthStateChanged(auth,u=>{
 if(!u) location.href="login.html";
 cargar();
});

async function cargar(){
 const q=await getDocs(collection(db,"models"));
 data=q.docs.map(d=>({...d.data(),id:d.id}));
 pintar();
}

function pintar(){
 models.innerHTML="";
 const t=search.value.toLowerCase();
 data.filter(m=>
 (m.modelo||"").toLowerCase().includes(t)||
 (m.fabricante||"").toLowerCase().includes(t)||
 (m.codigo||"").includes(t)
 ).forEach(m=>{
  models.innerHTML+=`
  <div class="card">
   <img src="${m.img||'https://via.placeholder.com/300x200?text=Sin+imagen'}">
   <b>${m.fabricante||""}</b><br>
   ${m.modelo||""}<br>
   ${m.escala||""}<br>
   <button onclick="borrar('${m.id}')">ğŸ—‘ï¸</button>
  </div>`;
 });
}

search.oninput=pintar;

window.nuevo=()=>modal.style.display="flex";
window.cerrar=()=>modal.style.display="none";

window.guardar=async()=>{
 await addDoc(collection(db,"models"),{
  codigo:codigo.value,
  fabricante:fabricante.value,
  modelo:modelo.value,
  escala:escala.value,
  img:imgurl.value
 });
 cerrar(); cargar();
};

window.borrar=async(id)=>{
 await deleteDoc(doc(db,"models",id));
 cargar();
};

window.buscarScalemates=async()=>{
 const q=codigo.value||modelo.value;
 const res=await fetch("https://TU-WORKER.cloudflare.workers.dev?q="+encodeURIComponent(q));
 const html=await res.text();

 // detecciÃ³n bÃ¡sica
 if(html.includes("Revell")) fabricante.value="Revell";
 if(html.includes("1:")) escala.value=html.match(/1:\d+/)?.[0]||"";
};

window.logout=()=>signOut(auth);

window.abrirConfig=()=>config.style.display="flex";
window.cerrarConfig=()=>config.style.display="none";
window.toggleTheme=()=>document.body.classList.toggle("dark");
window.setCols=()=>{
 document.documentElement.style.setProperty("--cols",cols.value);
};

</script>
</body>
</html>
