<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Maikman Models Stock</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
--bg:#0f172a; --card:#020617; --text:#e5e7eb; --accent:#38bdf8;
--min-card-width: 260px;
}
body.light {
--bg:#f1f5f9; --card:#fff; --text:#020617; --accent:#2563eb;
}
* { box-sizing:border-box; transition:.3s; }
body { margin:0; font-family:system-ui; background:var(--bg); color:var(--text); }
header { padding:20px; display:flex; justify-content:space-between; align-items:center; font-size:22px; font-weight:bold; }
button { background:var(--accent); border:none; padding:8px 14px; border-radius:6px; cursor:pointer; color:white; }
input { padding:8px; border-radius:6px; border:none; width:100%; }
#login { max-width:320px; margin:80px auto; background:var(--card); padding:20px; border-radius:12px; }
#app { display:none; }
#controls { display:flex; gap:10px; padding:20px; }
#grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(var(--min-card-width),1fr)); gap:16px; padding:20px; }
.card { background:var(--card); border-radius:12px; padding:12px; position:relative; }
.card img { width:100%; height:200px; object-fit:cover; border-radius:8px; }
.badge { position:absolute; bottom:8px; right:8px; background:#dc2626; color:white; border-radius:50%; width:28px; height:28px; display:flex; align-items:center; justify-content:center; font-weight:bold; }
.modal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:1000; }
.modal-content { background:var(--card); padding:20px; width:340px; border-radius:12px; display:flex; flex-direction:column; gap:10px; }
#paintsModal .modal-content { width:90%; max-width:1400px; max-height:92vh; overflow-y:auto; padding:24px; }
#paintsList { display:flex; flex-wrap:wrap; gap:32px; margin:20px 0; }
.paints-column { flex:1; min-width:240px; display:flex; flex-direction:column; gap:10px; }
.paints-item { display:flex; align-items:center; gap:12px; padding:6px 10px; border-radius:6px; background:rgba(255,255,255,0.06); font-size:14px; }
.paints-item button { background:none; border:none; color:#ef4444; font-weight:bold; cursor:pointer; font-size:18px; padding:0 8px; }
.paints-color { width:28px; height:28px; border:1px solid #4b5563; border-radius:6px; flex-shrink:0; }
#configModal .modal-content { width:420px; }
#configModal h4 { margin:20px 0 10px; font-size:18px; }
#configModal label { display:block; margin-bottom:12px; }
#configModal input[type="number"] { width:90px; padding:6px; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
<h2>Acceso</h2>
<input id="email" type="email" placeholder="Email"><br><br>
<input id="password" type="password" placeholder="Contrase√±a">
<label><input type="checkbox" onclick="verPassword()"> Ver contrase√±a</label><br><br>
<button onclick="login()">Entrar</button>
<p id="error" style="color:red;"></p>
</div>

<!-- APP -->
<div id="app">
<header>
üì¶ Maikman Models
<button onclick="openConfigModal()">‚öôÔ∏è</button>
</header>
<div id="controls">
<input id="search" placeholder="Buscar por c√≥digo, fabricante o modelo">
<button onclick="openModal()">‚ûï A√±adir nuevo modelo</button>
<button onclick="logout()">Salir</button>
</div>
<div id="grid"></div>
</div>

<!-- MODAL MODELO -->
<div id="modal" class="modal">
<div class="modal-content">
<h3 id="modalTitle">Nuevo modelo</h3>
<input id="codigo" placeholder="C√≥digo">
<input id="fabricante" placeholder="Fabricante">
<input id="modelo" placeholder="Modelo">
<b>Imagen</b>
<input id="fotoURL" placeholder="URL de la imagen (opcional)">
<input type="file" id="fotoFile" accept="image/*">
<button onclick="guardarModelo()">Guardar</button>
<button onclick="closeModal()">Cancelar</button>
</div>
</div>

<!-- MODAL PINTURAS -->
<div id="paintsModal" class="modal">
<div class="modal-content">
<h3>Pinturas Tamiya para <span id="currentModelName"></span></h3>
<input id="newPaints" placeholder="Ej: 9, h2, x-1, ts-14 (separados por coma)">
<div id="paintsList"></div>
<div style="display:flex; gap:12px; margin-top:20px;">
  <button onclick="savePaints()" style="flex:1; padding:12px;">Guardar cambios</button>
  <button onclick="closePaintsModal()" style="flex:1; padding:12px;">Cerrar</button>
</div>
</div>
</div>

<!-- MODAL CONFIGURACI√ìN -->
<div id="configModal" class="modal">
<div class="modal-content">
<h3>Configuraci√≥n</h3>
<div>
<h4>Tema</h4>
<button onclick="toggleTheme()">üåì Cambiar tema (actual: <span id="currentTheme">Oscuro</span>)</button>
</div>
<div>
<h4>Modelos</h4>
<label>Tarjetas por fila (aprox.): <input id="configCardsPerRow" type="number" min="1" max="8" step="1"></label>
</div>
<div>
<h4>Pinturas</h4>
<label>Items por columna: <input id="configItemsPerColumn" type="number" min="5" max="30" step="1"></label>
</div>
<div>
<h4>Datos</h4>
<button onclick="exportarModelos()">Exportar a Excel</button>
<label for="importFile">Importar desde Excel: <input type="file" id="importFile" accept=".xlsx,.xls"></label>
<button onclick="importarModelos()">Importar</button>
</div>
<button onclick="saveConfig()">Guardar</button>
<button onclick="closeConfigModal()">Cancelar</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAtWLxQfVqsEt8fLZkGRN-3zSHuzKMUTk8",
  authDomain: "maikmanmodelsstock.firebaseapp.com",
  projectId: "maikmanmodelsstock",
  storageBucket: "maikmanmodelsstock.appspot.com",
  messagingSenderId: "871520809912",
  appId: "1:871520809912:web:4042f15ef200832a95d54d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const loginBox = document.getElementById("login");
const appBox = document.getElementById("app");
const modal = document.getElementById("modal");
const paintsModal = document.getElementById("paintsModal");
const configModal = document.getElementById("configModal");
const grid = document.getElementById("grid");
const search = document.getElementById("search");

let modelos = [];
let editId = null;
let currentModel = null;

let itemsPerColumn = parseInt(localStorage.getItem('itemsPerColumn')) || 10;
let cardsPerRow = parseInt(localStorage.getItem('cardsPerRow')) || 4;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// applyConfig - se llama despu√©s del DOM ready
function applyConfig() {
  document.documentElement.style.setProperty('--min-card-width', `calc((100% - 40px) / ${cardsPerRow} - 16px)`);
  const theme = localStorage.getItem('theme') || 'dark';
  document.body.classList.toggle('light', theme === 'light');
  const currentThemeEl = document.getElementById('currentTheme');
  if (currentThemeEl) {
    currentThemeEl.innerText = theme === 'light' ? 'Claro' : 'Oscuro';
  }
}

// Esperamos a que el DOM est√© listo antes de aplicar config y cargar datos
document.addEventListener('DOMContentLoaded', () => {
  applyConfig();
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Gunze y pinturas
const gunzeToTamiya = {
  '1': 'X-2', '2': 'X-1', '3': 'X-7', '5': 'X-3', '7': 'X-9',
  '8': 'X-11', '9': 'X-12', '10': 'XF-6', '11': 'XF-2', '18': 'X-10',
  '25': 'X-14', '51': 'XF-12', '52': 'XF-53', '53': 'XF-53', '76': 'XF-84',
  '90': 'X-27', '92': 'X-26', '93': 'X-23', '94': 'X-25', '95': 'XF-19'
};

const tamiyaToGunze = {};
for (const [g, t] of Object.entries(gunzeToTamiya)) tamiyaToGunze[t] = g;

const paintsDict = {
  'X-1': { name: 'Negro', color: '#000000' },
  'X-2': { name: 'Blanco', color: '#FFFFFF' },
  'X-3': { name: 'Azul Real', color: '#003087' },
  'X-7': { name: 'Rojo', color: '#FF0000' },
  'X-8': { name: 'Amarillo Lim√≥n', color: '#FFFF00' },
  'X-12': { name: 'Oro', color: '#FFD700' },
  'XF-2': { name: 'Blanco Mate', color: '#F5F5F5' },
  'XF-16': { name: 'Aluminio Mate', color: '#A9A9A9' },
  'XF-19': { name: 'Gris Humo', color: '#778899' },
  'LP-21': { name: 'Rojo Italiano', color: '#B22222' },
  'TS-14': { name: 'Negro', color: '#1F1F1F' },
  // A√±ade aqu√≠ m√°s si necesitas
};

/* LOGIN */
window.login = () => 
  signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value)
    .catch(() => document.getElementById('error').innerText = "Credenciales incorrectas");

window.logout = () => signOut(auth);

onAuthStateChanged(auth, user => {
  loginBox.style.display = user ? "none" : "block";
  appBox.style.display = user ? "block" : "none";
  if (user) cargarModelos();
});

/* UI */
window.toggleTheme = () => {
  document.body.classList.toggle("light");
  localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
  document.getElementById('currentTheme').innerText = document.body.classList.contains('light') ? 'Claro' : 'Oscuro';
};

window.verPassword = () => {
  const pw = document.getElementById('password');
  pw.type = pw.type === "password" ? "text" : "password";
};

/* CONFIG */
window.openConfigModal = () => {
  configModal.style.display = 'flex';
  document.getElementById('configCardsPerRow').value = cardsPerRow;
  document.getElementById('configItemsPerColumn').value = itemsPerColumn;
};

window.closeConfigModal = () => configModal.style.display = 'none';

window.saveConfig = () => {
  cardsPerRow = Math.max(1, Math.min(8, parseInt(document.getElementById('configCardsPerRow').value) || 4));
  itemsPerColumn = Math.max(5, Math.min(30, parseInt(document.getElementById('configItemsPerColumn').value) || 10));
  localStorage.setItem('cardsPerRow', cardsPerRow);
  localStorage.setItem('itemsPerColumn', itemsPerColumn);
  applyConfig();
  closeConfigModal();
  pintar();
};

/* MODAL MODELO */
window.openModal = m => {
  modal.style.display = "flex";
  document.getElementById('modalTitle').innerText = m ? "Editar modelo" : "Nuevo modelo";
  document.getElementById('codigo').value = m?.codigo || "";
  document.getElementById('fabricante').value = m?.fabricante || "";
  document.getElementById('modelo').value = m?.modelo || "";
  document.getElementById('fotoURL').value = "";
  document.getElementById('fotoFile').value = "";
  editId = m?.id || null;
};

window.closeModal = () => modal.style.display = "none";

/* MODAL PINTURAS */
window.openPaintsModal = m => {
  if (!m || !m.id) return alert("Error: Modelo inv√°lido");
  currentModel = { ...m, paints: Array.isArray(m.paints) ? [...m.paints] : [] };
  paintsModal.style.display = "flex";
  document.getElementById("currentModelName").innerText = (m.codigo ? m.codigo + " ‚Äì " : "") + (m.modelo || "Modelo sin nombre");
  renderPaintsList();
};

window.closePaintsModal = () => paintsModal.style.display = "none";

function sortPaints(codes) {
  const seriesOrder = { 'X':1, 'XF':2, 'TS':3, 'LP':4 };
  return [...codes].sort((a,b) => {
    const pa = a.toUpperCase().split('-');
    const pb = b.toUpperCase().split('-');
    const sa = seriesOrder[pa[0]] || 99;
    const sb = seriesOrder[pb[0]] || 99;
    if (sa !== sb) return sa - sb;
    return (parseInt(pa[1]) || 9999) - (parseInt(pb[1]) || 9999);
  });
}

function renderPaintsList() {
  const list = document.getElementById("paintsList");
  list.innerHTML = "";
  const paints = Array.isArray(currentModel?.paints) ? currentModel.paints : [];
  if (paints.length === 0) {
    list.innerHTML = '<p style="color:#9ca3af;text-align:center;">A√∫n no hay pinturas a√±adidas</p>';
    return;
  }
  const sortedPaints = sortPaints(paints);
  const columns = [];
  for (let i = 0; i < sortedPaints.length; i += itemsPerColumn) {
    columns.push(sortedPaints.slice(i, i + itemsPerColumn));
  }
  columns.forEach(columnPaints => {
    const colDiv = document.createElement("div");
    colDiv.className = "paints-column";
    columnPaints.forEach(code => {
      const p = paintsDict[code];
      if (!p) return;
      const gunze = tamiyaToGunze[code] || '';
      const displayCode = gunze ? `${gunze} / ${code}` : code;
      const item = document.createElement("div");
      item.className = "paints-item";
      item.innerHTML = `
        <button onclick="deletePaint('${code.replace(/'/g,"\\'")}')">X</button>
        <div class="paints-color" style="background:${p.color};"></div>
        <span style="font-family:monospace; min-width:80px;">${displayCode}</span>
        <span>${p.name}</span>
      `;
      colDiv.appendChild(item);
    });
    list.appendChild(colDiv);
  });
}

window.deletePaint = code => {
  if (!Array.isArray(currentModel.paints)) currentModel.paints = [];
  const idx = currentModel.paints.indexOf(code);
  if (idx > -1) {
    currentModel.paints.splice(idx, 1);
    renderPaintsList();
  }
};

window.savePaints = async () => {
  if (!currentModel || !currentModel.id) {
    alert("Error: No se encontr√≥ el modelo.");
    closePaintsModal();
    return;
  }
  const input = document.getElementById("newPaints").value.trim();
  if (input) {
    const newCodes = input.split(',').map(normalizeCode)
      .filter(code => code && paintsDict[code] && !currentModel.paints.includes(code));
    if (newCodes.length > 0) {
      currentModel.paints.push(...newCodes);
      document.getElementById("newPaints").value = "";
      renderPaintsList();
    }
  }
  await updateDoc(doc(db, "modelos", currentModel.id), { paints: currentModel.paints || [] });
  closePaintsModal();
  cargarModelos();
};

function normalizeCode(c) {
  if (!c) return '';
  c = c.trim().toUpperCase().replace(/ /g, '').replace(/^H/i, '');
  if (/^\d+$/.test(c)) {
    const tamiya = gunzeToTamiya[c];
    if (tamiya) return tamiya;
  }
  if (!c.includes('-')) {
    const match = c.match(/^([A-Z]+)([\d]+)/);
    if (match) c = match[1] + '-' + match[2];
  }
  return c;
}

/* DATA */
async function cargarModelos() {
  modelos = [];
  const snap = await getDocs(collection(db, "modelos"));
  snap.forEach(d => modelos.push({ id: d.id, ...d.data() }));
  pintar();
}

function pintar() {
  const q = (search.value || "").toLowerCase().trim();
  grid.innerHTML = "";
  modelos.filter(m =>
    String(m.codigo || "").toLowerCase().includes(q) ||
    String(m.fabricante || "").toLowerCase().includes(q) ||
    String(m.modelo || "").toLowerCase().includes(q)
  ).forEach(m => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div style="position:relative">
        <img src="${m.foto || ''}" style="width:100%;height:200px;object-fit:cover;border-radius:8px;">
        ${m.duplicados > 1 ? `<div class="badge">${m.duplicados}</div>` : ''}
      </div>
      <b>${m.modelo || "Sin nombre"}</b><br>
      <small>${m.fabricante || "‚Äî"} ¬∑ ${m.codigo || "‚Äî"}</small><br><br>
    `;
    const btnEdit = document.createElement('button');
    btnEdit.textContent = '‚úèÔ∏è';
    btnEdit.onclick = () => openModal(m);
    const btnDelete = document.createElement('button');
    btnDelete.textContent = 'üóëÔ∏è';
    btnDelete.onclick = () => borrar(m.id);
    const btnPaint = document.createElement('button');
    btnPaint.textContent = 'üé®';
    btnPaint.onclick = () => openPaintsModal(m);
    card.append(btnEdit, btnDelete, btnPaint);
    grid.appendChild(card);
  });
}

/* SAVE MODELO */
window.guardarModelo = async () => {
  const codigo = String(document.getElementById('codigo').value || "").trim();
  const fabricante = String(document.getElementById('fabricante').value || "").trim();
  const modelo = String(document.getElementById('modelo').value || "").trim();

  const existente = modelos.find(m =>
    String(m.codigo) === codigo ||
    (String(m.fabricante).toLowerCase() === fabricante.toLowerCase() && String(m.modelo).toLowerCase() === modelo.toLowerCase())
  );

  if (existente && !editId) {
    if (!confirm("Este modelo ya existe.\n¬øQuieres a√±adir un duplicado?")) return;
    await updateDoc(doc(db, "modelos", existente.id), { duplicados: (existente.duplicados || 1) + 1 });
    closeModal();
    cargarModelos();
    return;
  }

  let fotoFinal = document.getElementById('fotoURL').value || '';
  if (!fotoFinal && document.getElementById('fotoFile').files[0]) {
    const r = ref(storage, "modelos/" + Date.now());
    await uploadBytes(r, document.getElementById('fotoFile').files[0]);
    fotoFinal = await getDownloadURL(r);
  }

  const data = { codigo, fabricante, modelo, foto: fotoFinal, duplicados: 1 };

  if (editId) await updateDoc(doc(db, "modelos", editId), data);
  else await addDoc(collection(db, "modelos"), data);

  closeModal();
  cargarModelos();
};

window.borrar = async id => {
  if (confirm("¬øBorrar modelo?")) {
    await deleteDoc(doc(db, "modelos", id));
    cargarModelos();
  }
};

search.addEventListener("input", pintar);

/* EXPORT / IMPORT */
window.exportarModelos = () => {
  const data = modelos.map(m => ({
    C√≥digo: m.codigo || '',
    Fabricante: m.fabricante || '',
    Modelo: m.modelo || '',
    Imagen: m.foto || '',
    Pinturas: (m.paints || []).join(',')
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Modelos");
  XLSX.writeFile(wb, 'maikman_models.xlsx');
};

window.importarModelos = async () => {
  const file = document.getElementById('importFile').files[0];
  if (!file) return alert('Selecciona un archivo Excel.');

  const reader = new FileReader();
  reader.onload = async e => {
    try {
      const wb = XLSX.read(e.target.result, { type: 'binary' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws, { header: ['C√≥digo', 'Fabricante', 'Modelo', 'Imagen', 'Pinturas'] }).slice(1);

      if (data.length === 0) return alert('El archivo est√° vac√≠o o no tiene datos.');

      let imported = 0;
      let updated = 0;

      for (const row of data) {
        const codigo = String(row['C√≥digo'] || "").trim();
        const fabricante = String(row['Fabricante'] || "").trim();
        const modelo = String(row['Modelo'] || "").trim();
        const foto = String(row['Imagen'] || "").trim();
        const pinturasStr = String(row['Pinturas'] || "").trim();

        const paints = pinturasStr 
          ? pinturasStr.split(',').map(c => normalizeCode(c.trim())).filter(code => code && paintsDict[code]) 
          : [];

        const existing = modelos.find(m => 
          String(m.codigo) === codigo &&
          String(m.fabricante).toLowerCase() === fabricante.toLowerCase() &&
          String(m.modelo).toLowerCase() === modelo.toLowerCase()
        );

        const modelData = { codigo, fabricante, modelo, foto, paints, duplicados: 1 };

        if (existing) {
          await updateDoc(doc(db, "modelos", existing.id), modelData);
          updated++;
        } else {
          await addDoc(collection(db, "modelos"), modelData);
          imported++;
        }
      }

      alert(`Importaci√≥n completada:\n- ${imported} nuevos\n- ${updated} actualizados`);
      await cargarModelos();
      pintar();

    } catch (err) {
      console.error('Error al importar:', err);
      alert('Error al procesar el Excel. Revisa la consola para detalles.');
    }
  };
  reader.readAsBinaryString(file);
};
</script>
</body>
</html>
