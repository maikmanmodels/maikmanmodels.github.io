<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Maikman Models Stock</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* Tu CSS completo - sin cambios, lo dejo igual */
:root {
--bg:#0f172a; --card:#020617; --text:#e5e7eb; --accent:#38bdf8;
--min-card-width: 260px;
}
body.light {
--bg:#f1f5f9; --card:#fff; --text:#020617; --accent:#2563eb;
}
* { box-sizing:border-box; transition:.3s; }
body { margin:0; font-family:system-ui; background:var(--bg); color:var(--text); }
header { padding:20px; display:flex; justify-content:space-between; align-items:center; font-size:22px; font-weight:bold; }
button { background:var(--accent); border:none; padding:8px 14px; border-radius:6px; cursor:pointer; color:white; }
input { padding:8px; border-radius:6px; border:none; width:100%; }
#login { max-width:320px; margin:80px auto; background:var(--card); padding:20px; border-radius:12px; }
#app { display:none; }
#controls { display:flex; gap:10px; padding:20px; }
#grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(var(--min-card-width),1fr)); gap:16px; padding:20px; }
.card { background:var(--card); border-radius:12px; padding:12px; position:relative; }
.card img { width:100%; height:200px; object-fit:cover; border-radius:8px; }
.card .buttons { display:flex; gap:14px; margin-top:12px; flex-wrap:wrap; }
.badge { position:absolute; bottom:8px; right:8px; background:#dc2626; color:white; border-radius:50%; width:28px; height:28px; display:flex; align-items:center; justify-content:center; font-weight:bold; }
.modal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:1000; }
.modal-content { background:var(--card); padding:24px; width:90%; max-width:400px; border-radius:12px; display:flex; flex-direction:column; gap:12px; max-height:90vh; overflow-y:auto; }
#paintsModal .modal-content { max-width:1400px; }
#paintsList { display:flex; flex-wrap:wrap; gap:32px; margin:20px 0; }
.paints-column { flex:1; min-width:240px; display:flex; flex-direction:column; gap:10px; }
.paints-item { display:flex; align-items:center; gap:12px; padding:8px; border-radius:6px; background:rgba(255,255,255,0.06); font-size:14px; }
.paints-item button { background:none; border:none; color:#ef4444; font-weight:bold; cursor:pointer; font-size:18px; padding:0 8px; }
.paints-color { width:28px; height:28px; border:1px solid #4b5563; border-radius:6px; flex-shrink:0; }
#infoModal .modal-content { max-width:700px; }
#infoGallery { display:flex; flex-wrap:wrap; gap:16px; margin-top:16px; }
#infoGallery img { width:180px; height:180px; object-fit:cover; border-radius:8px; border:1px solid #444; cursor:pointer; }
#configModal .modal-content { width:420px; }
#configModal h4 { margin:20px 0 10px; font-size:18px; }
#configModal label { display:block; margin-bottom:12px; }
#configModal input[type="number"] { width:90px; padding:6px; }
</style>
</head>
<body>

<!-- Tu HTML completo de login, app, modales... sin cambios -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAtWLxQfVqsEt8fLZkGRN-3zSHuzKMUTk8",
  authDomain: "maikmanmodelsstock.firebaseapp.com",
  projectId: "maikmanmodelsstock",
  storageBucket: "maikmanmodelsstock.appspot.com",
  messagingSenderId: "871520809912",
  appId: "1:871520809912:web:4042f15ef200832a95d54d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const loginBox = document.getElementById("login");
const appBox = document.getElementById("app");
const modal = document.getElementById("modal");
const paintsModal = document.getElementById("paintsModal");
const infoModal = document.getElementById("infoModal");
const configModal = document.getElementById("configModal");
const grid = document.getElementById("grid");
const search = document.getElementById("search");

let modelos = [];
let editId = null;
let currentModel = null;

let itemsPerColumn = parseInt(localStorage.getItem('itemsPerColumn')) || 10;
let cardsPerRow = parseInt(localStorage.getItem('cardsPerRow')) || 4;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Diccionarios y mapas ANTES de todo
const gunzeToTamiya = {
  '1': 'X-2', '2': 'X-1', '3': 'X-7', '4': 'X-8', '5': 'X-4', '6': 'X-5', '7': 'X-9',
  '8': 'X-11', '9': 'X-12', '10': 'XF-6', '11': 'XF-2', '12': 'XF-1', '13': 'XF-7',
  '14': 'X-6', '15': 'X-3', '16': 'XF-4', '17': 'XF-64', '18': 'X-10', '19': 'X-17',
  '20': 'X-10', '21': 'X-2', '22': 'XF-20', '23': 'XF-7', '25': 'X-14', '28': 'LP-40',
  '30': 'X-22', '33': 'XF-1', '47': 'X-27', '49': 'X-26', '50': 'X-23', '51': 'XF-12',
  '52': 'XF-53', '53': 'XF-53', '59': 'X-6', '62': 'XF-2', '76': 'XF-84', '88': 'X-13',
  '90': 'X-27', '91': 'X-24', '92': 'X-26', '93': 'X-23', '94': 'X-25', '95': 'XF-19'
};

const tamiyaToGunze = {};
for (const [g, t] of Object.entries(gunzeToTamiya)) {
  tamiyaToGunze[t] = g;
}

const paintsDict = {
  'X-1': { name: 'Negro', color: '#000000' },
  'X-2': { name: 'Blanco', color: '#FFFFFF' },
  'X-3': { name: 'Azul Real', color: '#003087' },
  'X-7': { name: 'Rojo', color: '#FF0000' },
  'X-8': { name: 'Amarillo LimÃ³n', color: '#FFFF00' },
  'X-10': { name: 'Gris CaÃ±Ã³n', color: '#3F3F3F' },
  'X-11': { name: 'Plateado Cromo', color: '#C0C0C0' },
  'X-12': { name: 'Dorado', color: '#FFD700' },
  'XF-2': { name: 'Blanco Mate', color: '#E8ECEF' },
  'XF-16': { name: 'Aluminio Mate', color: '#A9A9A9' },
  'LP-21': { name: 'Verde Italiano', color: '#2E4A2E' },
  'TS-14': { name: 'Negro', color: '#000000' },
  // ... aÃ±ade el resto de tu diccionario aquÃ­ si no estÃ¡ completo
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// applyConfig
function applyConfig() {
  document.documentElement.style.setProperty('--min-card-width', `calc((100% - 40px) / ${cardsPerRow} - 16px)`);
  const theme = localStorage.getItem('theme') || 'dark';
  document.body.classList.toggle('light', theme === 'light');
  const currentThemeEl = document.getElementById('currentTheme');
  if (currentThemeEl) {
    currentThemeEl.innerText = theme === 'light' ? 'Claro' : 'Oscuro';
  }
}

// Ejecutar applyConfig SOLO cuando el DOM estÃ© listo
document.addEventListener('DOMContentLoaded', () => {
  applyConfig();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/* LOGIN */
window.login = () => signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value)
  .catch(() => document.getElementById('error').innerText = "Credenciales incorrectas");

window.logout = () => signOut(auth);

onAuthStateChanged(auth, user => {
  loginBox.style.display = user ? "none" : "block";
  appBox.style.display = user ? "block" : "none";
  if (user) cargarModelos();
});

/* UI */
window.toggleTheme = () => {
  document.body.classList.toggle("light");
  localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
  const currentThemeEl = document.getElementById('currentTheme');
  if (currentThemeEl) {
    currentThemeEl.innerText = document.body.classList.contains('light') ? 'Claro' : 'Oscuro';
  }
};

window.verPassword = () => {
  const pw = document.getElementById('password');
  if (pw) pw.type = pw.type === "password" ? "text" : "password";
};

/* CONFIG */
window.openConfigModal = () => {
  configModal.style.display = 'flex';
  document.getElementById('configCardsPerRow').value = cardsPerRow;
  document.getElementById('configItemsPerColumn').value = itemsPerColumn;
};

window.closeConfigModal = () => configModal.style.display = 'none';

window.saveConfig = () => {
  cardsPerRow = Math.max(1, Math.min(8, parseInt(document.getElementById('configCardsPerRow').value) || 4));
  itemsPerColumn = Math.max(5, Math.min(30, parseInt(document.getElementById('configItemsPerColumn').value) || 10));
  localStorage.setItem('cardsPerRow', cardsPerRow);
  localStorage.setItem('itemsPerColumn', itemsPerColumn);
  applyConfig();
  closeConfigModal();
  pintar();
};

/* MODAL MODELO */
window.openModal = m => {
  modal.style.display = "flex";
  document.getElementById('modalTitle').innerText = m ? "Editar modelo" : "Nuevo modelo";
  document.getElementById('codigo').value = m?.codigo || "";
  document.getElementById('fabricante').value = m?.fabricante || "";
  document.getElementById('modelo').value = m?.modelo || "";
  document.getElementById('precio').value = m?.precio || "";
  document.getElementById('fotoURL').value = "";
  document.getElementById('fotoFile').value = "";
  document.getElementById('galeriaURLs').value = m?.galeria ? m.galeria.join(', ') : "";
  document.getElementById('galeriaFiles').value = "";
  editId = m?.id || null;
};

window.closeModal = () => modal.style.display = "none";

/* MODAL INFORMACIÃ“N */
window.openInfoModal = m => {
  infoModal.style.display = "flex";
  document.getElementById("infoModelName").innerText = m.modelo || "Sin nombre";
  document.getElementById("infoPrecio").innerText = m.precio != null ? m.precio + " â‚¬" : "No especificado";
  const gallery = document.getElementById("infoGallery");
  gallery.innerHTML = "";
  (m.galeria || []).forEach(url => {
    const img = document.createElement("img");
    img.src = url;
    gallery.appendChild(img);
  });
};

window.closeInfoModal = () => infoModal.style.display = "none";

/* MODAL PINTURAS */
window.openPaintsModal = m => {
  if (!m || !m.id) return alert("Error: Modelo invÃ¡lido");
  currentModel = { ...m, paints: Array.isArray(m.paints) ? [...m.paints] : [] };
  paintsModal.style.display = "flex";
  document.getElementById("currentModelName").innerText = (m.codigo ? m.codigo + " â€“ " : "") + (m.modelo || "Modelo sin nombre");
  renderPaintsList();
};

window.closePaintsModal = () => paintsModal.style.display = "none";

function sortPaints(codes) {
  const seriesOrder = { 'X':1, 'XF':2, 'TS':3, 'LP':4 };
  return [...codes].sort((a,b) => {
    const pa = a.toUpperCase().split('-');
    const pb = b.toUpperCase().split('-');
    const sa = seriesOrder[pa[0]] || 99;
    const sb = seriesOrder[pb[0]] || 99;
    if (sa !== sb) return sa - sb;
    return (parseInt(pa[1]) || 9999) - (parseInt(pb[1]) || 9999);
  });
}

function renderPaintsList() {
  const list = document.getElementById("paintsList");
  list.innerHTML = "";
  const paints = Array.isArray(currentModel?.paints) ? currentModel.paints : [];
  if (paints.length === 0) {
    list.innerHTML = '<p style="color:#9ca3af;text-align:center;">AÃºn no hay pinturas aÃ±adidas</p>';
    return;
  }
  const sortedPaints = sortPaints(paints);
  const columns = [];
  for (let i = 0; i < sortedPaints.length; i += itemsPerColumn) {
    columns.push(sortedPaints.slice(i, i + itemsPerColumn));
  }
  columns.forEach(columnPaints => {
    const colDiv = document.createElement("div");
    colDiv.className = "paints-column";
    columnPaints.forEach(code => {
      const p = paintsDict[code];
      if (!p) return;
      const gunze = tamiyaToGunze[code] || '';
      const displayCode = gunze ? `${gunze} / ${code}` : code;
      const item = document.createElement("div");
      item.className = "paints-item";
      item.innerHTML = `
        <button onclick="deletePaint('${code.replace(/'/g,"\\'")}')">X</button>
        <div class="paints-color" style="background:${p.color};"></div>
        <span style="font-family:monospace; min-width:80px;">${displayCode}</span>
        <span>${p.name}</span>
      `;
      colDiv.appendChild(item);
    });
    list.appendChild(colDiv);
  });
}

window.deletePaint = code => {
  if (!Array.isArray(currentModel.paints)) currentModel.paints = [];
  const idx = currentModel.paints.indexOf(code);
  if (idx > -1) {
    currentModel.paints.splice(idx, 1);
    renderPaintsList();
  }
};

window.savePaints = async () => {
  if (!currentModel || !currentModel.id) {
    alert("Error: No se encontrÃ³ el modelo.");
    closePaintsModal();
    return;
  }
  const input = document.getElementById("newPaints").value.trim();
  if (input) {
    const newCodes = input.split(',').map(normalizeCode)
      .filter(code => code && paintsDict[code] && !currentModel.paints.includes(code));
    if (newCodes.length > 0) {
      currentModel.paints.push(...newCodes);
      document.getElementById("newPaints").value = "";
      renderPaintsList();
    }
  }
  await updateDoc(doc(db, "modelos", currentModel.id), { paints: currentModel.paints || [] });
  closePaintsModal();
  cargarModelos();
};

function normalizeCode(c) {
  if (!c) return '';
  c = c.trim().toUpperCase().replace(/ /g, '').replace(/^H/i, '');
  if (/^\d+$/.test(c)) {
    const tamiya = gunzeToTamiya[c];
    if (tamiya) return tamiya;
  }
  if (!c.includes('-')) {
    const match = c.match(/^([A-Z]+)([\d]+)/);
    if (match) c = match[1] + '-' + match[2];
  }
  return c;
}

/* DATA */
async function cargarModelos() {
  modelos = [];
  const snap = await getDocs(collection(db, "modelos"));
  snap.forEach(d => modelos.push({ id: d.id, ...d.data() }));
  pintar();
}

function pintar() {
  const q = (search.value || "").toLowerCase().trim();
  grid.innerHTML = "";
  modelos.filter(m =>
    String(m.codigo || "").toLowerCase().includes(q) ||
    String(m.fabricante || "").toLowerCase().includes(q) ||
    String(m.modelo || "").toLowerCase().includes(q)
  ).forEach(m => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div style="position:relative">
        <img src="${m.foto || ''}" style="width:100%;height:200px;object-fit:cover;border-radius:8px;">
        ${m.duplicados > 1 ? `<div class="badge">${m.duplicados}</div>` : ''}
      </div>
      <b>${m.modelo || "Sin nombre"}</b><br>
      <small>${m.fabricante || "â€”"} Â· ${m.codigo || "â€”"}</small><br><br>
    `;
    const btnEdit = document.createElement('button');
    btnEdit.textContent = 'âœï¸';
    btnEdit.onclick = () => openModal(m);
    const btnDelete = document.createElement('button');
    btnDelete.textContent = 'ðŸ—‘ï¸';
    btnDelete.onclick = () => borrar(m.id);
    const btnPaint = document.createElement('button');
    btnPaint.textContent = 'ðŸŽ¨';
    btnPaint.onclick = () => openPaintsModal(m);
    const btnInfo = document.createElement('button');
    btnInfo.textContent = 'i';
    btnInfo.onclick = () => openInfoModal(m);
    card.append(btnEdit, btnDelete, btnPaint, btnInfo);
    grid.appendChild(card);
  });
}

/* SAVE MODELO */
window.guardarModelo = async () => {
  const codigo = String(document.getElementById('codigo').value || "").trim();
  const fabricante = String(document.getElementById('fabricante').value || "").trim();
  const modelo = String(document.getElementById('modelo').value || "").trim();
  const precio = document.getElementById('precio').value ? parseFloat(document.getElementById('precio').value) : null;

  const existente = modelos.find(m =>
    String(m.codigo) === codigo ||
    (String(m.fabricante).toLowerCase() === fabricante.toLowerCase() && String(m.modelo).toLowerCase() === modelo.toLowerCase())
  );

  if (existente && !editId) {
    if (!confirm("Este modelo ya existe.\nÂ¿Quieres aÃ±adir un duplicado?")) return;
    await updateDoc(doc(db, "modelos", existente.id), { duplicados: (existente.duplicados || 1) + 1 });
    closeModal();
    cargarModelos();
    return;
  }

  let fotoFinal = document.getElementById('fotoURL').value || '';
  if (!fotoFinal && document.getElementById('fotoFile').files[0]) {
    const r = ref(storage, "modelos/" + Date.now());
    await uploadBytes(r, document.getElementById('fotoFile').files[0]);
    fotoFinal = await getDownloadURL(r);
  } else if (editId && !fotoFinal && !document.getElementById('fotoFile').files[0]) {
    const existing = modelos.find(m => m.id === editId);
    fotoFinal = existing?.foto || '';
  }

  let galeriaFinal = [];
  if (editId) {
    const existing = modelos.find(m => m.id === editId);
    galeriaFinal = existing?.galeria || [];
  }
  const urls = document.getElementById('galeriaURLs').value.split(',').map(u => u.trim()).filter(u => u);
  urls.forEach(u => {
    if (!galeriaFinal.includes(u)) galeriaFinal.push(u);
  });
  for (const file of document.getElementById('galeriaFiles').files) {
    const r = ref(storage, "galeria/" + Date.now());
    await uploadBytes(r, file);
    galeriaFinal.push(await getDownloadURL(r));
  }

  const data = {
    codigo,
    fabricante,
    modelo,
    precio,
    foto: fotoFinal,
    galeria: galeriaFinal,
    duplicados: 1
  };

  if (editId) await updateDoc(doc(db, "modelos", editId), data);
  else await addDoc(collection(db, "modelos"), data);

  closeModal();
  cargarModelos();
};

window.borrar = async id => {
  if (confirm("Â¿Borrar modelo?")) {
    await deleteDoc(doc(db, "modelos", id));
    cargarModelos();
  }
};

search.addEventListener("input", pintar);

/* EXPORT / IMPORT */
window.exportarModelos = () => {
  const data = modelos.map(m => ({
    CÃ³digo: m.codigo || '',
    Fabricante: m.fabricante || '',
    Modelo: m.modelo || '',
    Precio: m.precio || '',
    Imagen: m.foto || '',
    GalerÃ­a: (m.galeria || []).join(', '),
    Pinturas: (m.paints || []).join(',')
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Modelos");
  XLSX.writeFile(wb, 'maikman_models.xlsx');
};

window.importarModelos = async () => {
  const file = document.getElementById('importFile').files[0];
  if (!file) return alert('Selecciona un archivo Excel.');
  const reader = new FileReader();
  reader.onload = async e => {
    try {
      const wb = XLSX.read(e.target.result, { type: 'binary' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws, { header: ['CÃ³digo', 'Fabricante', 'Modelo', 'Precio', 'Imagen', 'GalerÃ­a', 'Pinturas'] }).slice(1);
      if (data.length === 0) return alert('El archivo estÃ¡ vacÃ­o o no tiene datos.');
      let imported = 0;
      let updated = 0;
      for (const row of data) {
        const codigo = String(row['CÃ³digo'] || "").trim();
        const fabricante = String(row['Fabricante'] || "").trim();
        const modelo = String(row['Modelo'] || "").trim();
        const precio = row['Precio'] ? parseFloat(row['Precio']) : null;
        const foto = String(row['Imagen'] || "").trim();
        const galeriaStr = String(row['GalerÃ­a'] || "").trim();
        const galeria = galeriaStr ? galeriaStr.split(',').map(u => u.trim()).filter(u => u) : [];
        const pinturasStr = String(row['Pinturas'] || "").trim();
        const paints = pinturasStr ? pinturasStr.split(',').map(c => normalizeCode(c.trim())).filter(code => code && paintsDict[code]) : [];
        const existing = modelos.find(m => 
          String(m.codigo) === codigo &&
          String(m.fabricante).toLowerCase() === fabricante.toLowerCase() &&
          String(m.modelo).toLowerCase() === modelo.toLowerCase()
        );
        const modelData = { codigo, fabricante, modelo, precio, foto, galeria, paints, duplicados: 1 };
        if (existing) {
          await updateDoc(doc(db, "modelos", existing.id), modelData);
          updated++;
        } else {
          await addDoc(collection(db, "modelos"), modelData);
          imported++;
        }
      }
      alert(`ImportaciÃ³n completada:\n- ${imported} nuevos\n- ${updated} actualizados`);
      await cargarModelos();
      pintar();
    } catch (err) {
      console.error('Error al importar:', err);
      alert('Error al procesar el Excel. Revisa la consola.');
    }
  };
  reader.readAsBinaryString(file);
};
</script>
</body>
</html>
