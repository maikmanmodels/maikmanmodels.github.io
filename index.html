<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Maikman Models Stock</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  margin:0;
  padding:20px;
}

.hidden { display:none; }

button {
  margin:2px;
  padding:6px 10px;
  cursor:pointer;
}

#models div {
  background:white;
  padding:10px;
  margin-bottom:8px;
  border-radius:6px;
}

.modal {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
}

.modal-content {
  background:white;
  padding:20px;
  width:400px;
  border-radius:8px;
}
</style>
</head>

<body>

<h1>Maikman Models</h1>

<!-- LOGIN -->
<div id="login">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button id="loginBtn">Entrar</button>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <h2>Modelos</h2>
  <input id="modelName" placeholder="Nuevo modelo">
  <button onclick="addModel()">A√±adir modelo</button>

  <div id="models"></div>
</div>

<!-- MODAL PINTURAS -->
<div id="paintModal" class="modal">
  <div class="modal-content">
    <h3>Pinturas Tamiya</h3>
    <p>Ej: x1, xf-3, lp5, ts13</p>
    <textarea id="paintInput" style="width:100%;height:80px;"></textarea>
    <br><br>
    <button onclick="savePaints()">Guardar</button>
    <button onclick="closePaintModal()">Cerrar</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyAtWLxQfVqsEt8fLZkGRN-3zSHuzKMUTk8",
  authDomain:"maikmanmodelsstock.firebaseapp.com",
  projectId:"maikmanmodelsstock",
  storageBucket:"maikmanmodelsstock.appspot.com",
  messagingSenderId:"871520809912",
  appId:"1:871520809912:web:4042f15ef200832a95d54d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginDiv = document.getElementById("login");
const appDiv = document.getElementById("app");
const modelsDiv = document.getElementById("models");

let currentPaintModelId = null;

document.getElementById("loginBtn").onclick = () => {
  signInWithEmailAndPassword(
    auth,
    email.value,
    password.value
  );
};

onAuthStateChanged(auth, user => {
  if (user) {
    loginDiv.classList.add("hidden");
    appDiv.classList.remove("hidden");
    loadModels();
  }
});

async function loadModels() {
  modelsDiv.innerHTML = "";
  const snap = await getDocs(collection(db,"models"));

  snap.forEach(d => {
    const m = d.data();
    const div = document.createElement("div");

    div.innerHTML = `
      <b>${m.name}</b><br>
      Pinturas: ${(m.paints || []).join(", ") || "‚Äî"}<br>
      <button onclick="openPaintModal('${d.id}', '${(m.paints||[]).join(",")}')">üé® Pinturas</button>
      <button onclick="deleteModel('${d.id}')">‚ùå</button>
    `;

    modelsDiv.appendChild(div);
  });
}

window.addModel = async () => {
  if (!modelName.value) return;
  await addDoc(collection(db,"models"), {
    name: modelName.value,
    paints:[]
  });
  modelName.value="";
  loadModels();
};

window.deleteModel = async id => {
  await deleteDoc(doc(db,"models",id));
  loadModels();
};

window.openPaintModal = (id, paints) => {
  currentPaintModelId = id;
  paintInput.value = paints;
  paintModal.style.display = "flex";
};

window.closePaintModal = () => {
  paintModal.style.display = "none";
  currentPaintModelId = null;
};

function normalizePaint(p) {
  p = p.trim().toUpperCase().replace("-", "");
  const m = p.match(/^(X|XF|LP|TS)(\d+)$/);
  return m ? `${m[1]}-${m[2]}` : null;
}

window.savePaints = async () => {
  if (!currentPaintModelId) return;

  const raw = paintInput.value.split(",");
  const normalized = [...new Set(
    raw.map(normalizePaint).filter(Boolean)
  )];

  await updateDoc(
    doc(db,"models",currentPaintModelId),
    { paints: normalized }
  );

  closePaintModal();
  loadModels();
};
</script>

</body>
</html>
