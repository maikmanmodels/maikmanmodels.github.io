<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Maikman Models Stock</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
  --bg:#0f172a; --card:#020617; --text:#e5e7eb; --accent:#38bdf8;
}
body.light {
  --bg:#f1f5f9; --card:#fff; --text:#020617; --accent:#2563eb;
}
* { box-sizing:border-box; transition:.3s; }
body { margin:0; font-family:system-ui; background:var(--bg); color:var(--text); }

header {
  padding:20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:22px;
  font-weight:bold;
}

button {
  background:var(--accent);
  border:none;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
  color:white;
}

input, select {
  padding:8px;
  border-radius:6px;
  border:none;
  width:100%;
}

#login {
  max-width:320px;
  margin:80px auto;
  background:var(--card);
  padding:20px;
  border-radius:12px;
}

#app { display:none; }

#controls {
  display:flex;
  gap:10px;
  padding:20px;
  flex-wrap:wrap;
}

#grid {
  display:grid;
  gap:16px;
  padding:20px;
}

.card {
  background:var(--card);
  border-radius:12px;
  padding:12px;
}

.card img {
  width:100%;
  height:200px;
  object-fit:cover;
  border-radius:8px;
}

.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
}

.modal-content {
  background:var(--card);
  padding:20px;
  width:340px;
  border-radius:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <h2>Acceso</h2>
  <input id="email" type="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="Contrase√±a">
  <label><input type="checkbox" onclick="verPassword()"> Ver contrase√±a</label><br><br>
  <button onclick="login()">Entrar</button>
  <p id="error" style="color:red;"></p>
</div>

<!-- APP -->
<div id="app">
<header>
  üì¶ Maikman Models
  <div>
    <button onclick="openSettings()">‚öôÔ∏è</button>
    <button onclick="logout()">Salir</button>
  </div>
</header>

<div id="controls">
  <input id="search" placeholder="Buscar por c√≥digo, fabricante o modelo">
  <button onclick="openModal()">‚ûï A√±adir nuevo modelo</button>
</div>

<div id="grid"></div>
</div>

<!-- MODAL MODELO -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Nuevo modelo</h3>
    <input id="codigo" placeholder="C√≥digo">
    <input id="fabricante" placeholder="Fabricante">
    <input id="modelo" placeholder="Modelo">

    <b>Imagen</b>
    <input id="fotoURL" placeholder="URL de la imagen (opcional)">
    <input type="file" id="fotoFile" accept="image/*">

    <button onclick="guardarModelo()">Guardar</button>
    <button onclick="closeModal()">Cancelar</button>
  </div>
</div>

<!-- MODAL AJUSTES -->
<div id="settings" class="modal">
  <div class="modal-content">
    <h3>‚öôÔ∏è Configuraci√≥n</h3>

    <label>
      Tema
      <select onchange="setTheme(this.value)">
        <option value="dark">Oscuro</option>
        <option value="light">Claro</option>
      </select>
    </label>

    <label id="columnsLabel">
      Tarjetas por fila (PC)
      <select onchange="setColumns(this.value)">
        <option>1</option><option>2</option><option>3</option>
        <option>4</option><option>5</option>
      </select>
    </label>

    <button onclick="closeSettings()">Cerrar</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey:"AIzaSyAtWLxQfVqsEt8fLZkGRN-3zSHuzKMUTk8",
  authDomain:"maikmanmodelsstock.firebaseapp.com",
  projectId:"maikmanmodelsstock",
  storageBucket:"maikmanmodelsstock.appspot.com",
  messagingSenderId:"871520809912",
  appId:"1:871520809912:web:4042f15ef200832a95d54d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const loginBox = login;
const appBox = app;
const grid = document.getElementById("grid");
const search = document.getElementById("search");

let modelos = [];
let editId = null;

/* ===== AUTH ===== */
window.login = () =>
  signInWithEmailAndPassword(auth,email.value,password.value)
  .catch(()=>error.innerText="Credenciales incorrectas");

window.logout = () => signOut(auth);

onAuthStateChanged(auth,user=>{
  loginBox.style.display = user?"none":"block";
  appBox.style.display = user?"block":"none";
  if(user) cargarModelos();
});

/* ===== RESPONSIVE GRID ===== */
function isMobile(){
  return window.innerWidth < 768;
}

function aplicarGrid(){
  let cols = isMobile() ? 1 : localStorage.getItem("cols") || 3;
  grid.style.gridTemplateColumns = `repeat(${cols},1fr)`;
  document.getElementById("columnsLabel").style.display =
    isMobile() ? "none" : "block";
}
window.addEventListener("resize", aplicarGrid);

/* ===== THEME ===== */
window.setTheme = t=>{
  document.body.classList.toggle("light", t==="light");
  localStorage.setItem("theme",t);
};
window.verPassword = () =>
  password.type = password.type==="password"?"text":"password";

/* ===== SETTINGS ===== */
window.openSettings = ()=> settings.style.display="flex";
window.closeSettings = ()=> settings.style.display="none";
window.setColumns = c=>{
  localStorage.setItem("cols",c);
  aplicarGrid();
};

/* ===== MODAL MODELO ===== */
window.openModal = m=>{
  modal.style.display="flex";
  modalTitle.innerText = m?"Editar modelo":"Nuevo modelo";
  codigo.value = m?.codigo || "";
  fabricante.value = m?.fabricante || "";
  modelo.value = m?.modelo || "";
  fotoURL.value = "";
  fotoFile.value = "";
  editId = m?.id || null;
};
window.closeModal = ()=> modal.style.display="none";

/* ===== DATA ===== */
async function cargarModelos(){
  modelos=[];
  const snap=await getDocs(collection(db,"modelos"));
  snap.forEach(d=>modelos.push({id:d.id,...d.data()}));
  pintar();
  aplicarGrid();
}

function pintar(){
  const q=search.value.toLowerCase();
  grid.innerHTML="";
  modelos.filter(m =>
    (m.codigo||"").toLowerCase().includes(q) ||
    (m.fabricante||"").toLowerCase().includes(q) ||
    (m.modelo||"").toLowerCase().includes(q)
  ).forEach(m=>{
    grid.innerHTML+=`
    <div class="card">
      <img src="${m.foto||''}">
      <b>${m.modelo||"Sin nombre"}</b><br>
      <small>${m.fabricante||"‚Äî"} ¬∑ ${m.codigo||"‚Äî"}</small><br><br>
      <button onclick='editar(${JSON.stringify(m)})'>‚úèÔ∏è</button>
      <button onclick="borrar('${m.id}')">üóëÔ∏è</button>
    </div>`;
  });
}

/* ===== SAVE ===== */
window.guardarModelo = async ()=>{
  let fotoFinal="";
  if(fotoURL.value.trim()){
    fotoFinal = fotoURL.value.trim();
  } else if(fotoFile.files[0]){
    const r = ref(storage,"modelos/"+Date.now());
    await uploadBytes(r,fotoFile.files[0]);
    fotoFinal = await getDownloadURL(r);
  }

  const data={ codigo:codigo.value||"", fabricante:fabricante.value||"", modelo:modelo.value||"", foto:fotoFinal };

  if(editId) await updateDoc(doc(db,"modelos",editId),data);
  else await addDoc(collection(db,"modelos"),data);

  closeModal();
  cargarModelos();
};

window.editar = m => openModal(m);
window.borrar = async id=>{
  if(confirm("¬øBorrar modelo?")){
    await deleteDoc(doc(db,"modelos",id));
    cargarModelos();
  }
};

search.addEventListener("input",pintar);

/* ===== INIT ===== */
const savedTheme = localStorage.getItem("theme");
if(savedTheme==="light") document.body.classList.add("light");
</script>

</body>
</html>
