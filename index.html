<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Maikman Models Stock</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
:root{--bg:#f4f4f4;--card:#fff;--text:#111;--accent:#007bff}
body.dark{--bg:#121212;--card:#1e1e1e;--text:#eee;--accent:#4dabf7}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
header{display:flex;justify-content:space-between;padding:1rem}
button{padding:.5rem .8rem;border:none;border-radius:8px;background:var(--accent);color:#fff;cursor:pointer}
input{padding:.6rem;border-radius:6px;border:1px solid #ccc;width:100%}
.card{background:var(--card);padding:1rem;border-radius:12px;margin:1rem}
#models{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem}
.model img{width:100%;height:180px;object-fit:cover;border-radius:8px}
.actions{display:flex;gap:.5rem;margin-top:.5rem}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:10}
.modal-content{background:var(--card);padding:1rem;border-radius:12px;width:90%;max-width:420px}
#camera{width:100%}
</style>
</head>

<body>

<header>
  <h2>Maikman Models</h2>
  <div>
    <button onclick="toggleTheme()">üåô</button>
    <button onclick="logout()">Salir</button>
  </div>
</header>

<div id="login" class="card">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Contrase√±a">
  <label><input type="checkbox" onclick="verPass()"> Ver</label>
  <button onclick="login()">Entrar</button>
  <p id="error" style="color:red"></p>
</div>

<div id="app" style="display:none">
  <div class="card">
    <input id="busqueda" placeholder="Buscar por c√≥digo, fabricante o modelo">
    <button onclick="nuevo()">‚ûï A√±adir</button>
  </div>
  <div id="models"></div>
</div>

<!-- MODAL MODELO -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitulo">Nuevo modelo</h3>
    <button onclick="abrirScanner()">üì∑ Escanear</button><br><br>

    <input id="codigo" placeholder="C√≥digo">
    <input id="fabricante" placeholder="Fabricante">
    <input id="modelo" placeholder="Modelo">
    <input id="imgUrl" placeholder="URL imagen">
    <input id="imgFile" type="file">

    <div class="actions">
      <button onclick="guardar()">Guardar</button>
      <button onclick="cerrarModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- SCANNER -->
<div id="scanner" class="modal">
  <div class="modal-content">
    <div id="camera"></div>
    <button onclick="cerrarScanner()">Cancelar</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const el=id=>document.getElementById(id);
const placeholderImg =
"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjMwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNlZWUiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzk5OSI+U2luIGltYWdlbjwvdGV4dD48L3N2Zz4=";

const app=initializeApp({
 apiKey:"AIzaSyAtWLxQfVqsEt8fLZkGRN-3zSHuzKMUTk8",
 authDomain:"maikmanmodelsstock.firebaseapp.com",
 projectId:"maikmanmodelsstock",
 storageBucket:"maikmanmodelsstock.appspot.com",
 messagingSenderId:"871520809912",
 appId:"1:871520809912:web:4042f15ef200832a95d54d"
});

const auth=getAuth(app);
const db=getFirestore(app);
const storage=getStorage(app);

let modelos=[];
let editId=null;

/* AUTH */
window.login=()=>signInWithEmailAndPassword(auth,email.value,password.value)
.catch(()=>error.innerText="Credenciales incorrectas");
window.logout=()=>signOut(auth);
onAuthStateChanged(auth,u=>{
 el("login").style.display=u?"none":"block";
 el("app").style.display=u?"block":"none";
 if(u)cargar();
});

/* DATA */
async function cargar(){
 modelos=[];
 const q=await getDocs(collection(db,"modelos"));
 q.forEach(d=>modelos.push({...d.data(),id:d.id}));
 pintar();
}

function pintar(){
 const t=busqueda.value.toLowerCase();
 models.innerHTML="";
 modelos.filter(m=>
  (m.codigo||"").toLowerCase().includes(t)||
  (m.fabricante||"").toLowerCase().includes(t)||
  (m.modelo||"").toLowerCase().includes(t)
 ).forEach(m=>{
  const img=m.imagen||placeholderImg;
  models.innerHTML+=`
   <div class="card model">
    <img src="${img}">
    <b>${m.modelo||""}</b><br>
    ${m.fabricante||""}<br>${m.codigo||""}
    <div class="actions">
      <button onclick="editar('${m.id}')">‚úèÔ∏è</button>
      <button onclick="borrar('${m.id}')">üóë</button>
    </div>
   </div>`;
 });
}
busqueda.oninput=pintar;

/* MODAL */
window.nuevo=()=>{
 editId=null;
 modalTitulo.innerText="Nuevo modelo";
 ["codigo","fabricante","modelo","imgUrl"].forEach(i=>el(i).value="");
 imgFile.value="";
 modal.style.display="flex";
};

window.editar=id=>{
 const m=modelos.find(x=>x.id===id);
 editId=id;
 modalTitulo.innerText="Editar modelo";
 codigo.value=m.codigo||"";
 fabricante.value=m.fabricante||"";
 modelo.value=m.modelo||"";
 imgUrl.value=m.imagen||"";
 modal.style.display="flex";
};

window.cerrarModal=()=>modal.style.display="none";

/* GUARDAR */
window.guardar=async()=>{
 let imagen=imgUrl.value;
 if(imgFile.files[0]){
  const r=ref(storage,"modelos/"+Date.now());
  await uploadBytes(r,imgFile.files[0]);
  imagen=await getDownloadURL(r);
 }

 const data={
  codigo:codigo.value,
  fabricante:fabricante.value,
  modelo:modelo.value,
  imagen
 };

 if(editId){
  await updateDoc(doc(db,"modelos",editId),data);
 } else {
  await addDoc(collection(db,"modelos"),data);
 }

 cerrarModal();
 cargar();
};

/* BORRAR */
window.borrar=async id=>{
 if(confirm("¬øBorrar modelo?")){
  await deleteDoc(doc(db,"modelos",id));
  cargar();
 }
};

/* UI */
window.toggleTheme=()=>document.body.classList.toggle("dark");
window.verPass=()=>password.type=password.type==="password"?"text":"password";

/* ESC√ÅNER */
window.abrirScanner=()=>{
 scanner.style.display="flex";
 Quagga.init({
  inputStream:{type:"LiveStream",target:document.querySelector("#camera")},
  decoder:{readers:["ean_reader","upc_reader","ean_8_reader"]}
 },()=>Quagga.start());
 Quagga.onDetected(d=>{
  const code=d.codeResult.code;
  Quagga.stop();
  cerrarScanner();
  codigo.value=code;
  buscarAPI(code);
 });
};

window.cerrarScanner=()=>{
 scanner.style.display="none";
 Quagga.stop();
};

async function buscarAPI(code){
 const r=await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
 const j=await r.json();
 if(j.status===1 && confirm("Datos encontrados. ¬øUsarlos?")){
  fabricante.value=j.product.brands||"";
  modelo.value=j.product.product_name||"";
  if(j.product.image_url) imgUrl.value=j.product.image_url;
 }
}
</script>

</body>
</html>
