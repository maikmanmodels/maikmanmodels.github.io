<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Maikman Models Stock</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#f4f4f4;--card:#fff;--text:#111;--accent:#007bff
}
body.dark{
  --bg:#121212;--card:#1e1e1e;--text:#eee;--accent:#4dabf7
}
body{
  margin:0;
  font-family:system-ui;
  background:var(--bg);
  color:var(--text);
  transition:.3s;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:1rem;
}
button{
  padding:.6rem 1rem;
  border:none;
  border-radius:8px;
  background:var(--accent);
  color:white;
  cursor:pointer;
}
input{
  padding:.6rem;
  border-radius:6px;
  border:1px solid #ccc;
  width:100%;
}
.card{
  background:var(--card);
  padding:1rem;
  border-radius:12px;
  margin:1rem;
}
#models{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:1rem;
}
.model img{
  width:100%;
  height:180px;
  object-fit:cover;
  border-radius:8px;
}
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10;
}
.modal-content{
  background:var(--card);
  padding:1rem;
  border-radius:12px;
  width:90%;
  max-width:420px;
}
video{width:100%;border-radius:8px}
</style>
</head>

<body>

<header>
  <h2>Maikman Models</h2>
  <div>
    <button id="themeBtn">ðŸŒ™</button>
    <button id="logoutBtn">Salir</button>
  </div>
</header>

<div id="login" class="card">
  <h3>Acceso</h3>
  <input id="email" type="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="ContraseÃ±a">
  <label><input type="checkbox" id="verPass"> Ver contraseÃ±a</label><br><br>
  <button id="loginBtn">Entrar</button>
  <p id="error" style="color:red"></p>
</div>

<div id="app" style="display:none">
  <div class="card">
    <input id="busqueda" placeholder="Buscar por cÃ³digo, fabricante o modelo"><br><br>
    <button id="addBtn">âž• AÃ±adir nuevo modelo</button>
  </div>
  <div id="models"></div>
</div>

<!-- MODAL MODELO -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3>Nuevo modelo</h3>
    <button id="scanBtn">ðŸ“· Escanear cÃ³digo</button><br><br>

    <input id="codigo" placeholder="CÃ³digo"><br><br>
    <input id="fabricante" placeholder="Fabricante"><br><br>
    <input id="modelo" placeholder="Modelo"><br><br>

    <input id="imgUrl" placeholder="URL imagen (opcional)"><br><br>
    <input id="imgFile" type="file" accept="image/*"><br><br>

    <button id="saveBtn">Guardar</button>
    <button id="cancelBtn">Cancelar</button>
  </div>
</div>

<!-- MODAL SCANNER -->
<div id="scanner" class="modal">
  <div class="modal-content">
    <h3>Escanear cÃ³digo</h3>
    <video id="video" autoplay></video><br><br>
    <button id="closeScan">Cancelar</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

/* ===== ELEMENTOS ===== */
const el = id => document.getElementById(id);

const loginBox = el("login");
const appBox = el("app");
const modelsBox = el("models");
const modal = el("modal");
const scanner = el("scanner");
const video = el("video");

/* ===== FIREBASE ===== */
const firebaseConfig={
 apiKey:"AIzaSyAtWLxQfVqsEt8fLZkGRN-3zSHuzKMUTk8",
 authDomain:"maikmanmodelsstock.firebaseapp.com",
 projectId:"maikmanmodelsstock",
 storageBucket:"maikmanmodelsstock.appspot.com",
 messagingSenderId:"871520809912",
 appId:"1:871520809912:web:4042f15ef200832a95d54d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let modelos=[];
let stream=null;
let detector=null;

/* ===== AUTH ===== */
el("loginBtn").onclick = ()=>{
 signInWithEmailAndPassword(auth, el("email").value, el("password").value)
 .catch(()=>el("error").innerText="Credenciales incorrectas");
};

el("logoutBtn").onclick = ()=>signOut(auth);

onAuthStateChanged(auth,user=>{
 loginBox.style.display = user ? "none" : "block";
 appBox.style.display = user ? "block" : "none";
 if(user) cargar();
});

/* ===== DATA ===== */
async function cargar(){
 modelos=[];
 const q=await getDocs(collection(db,"modelos"));
 q.forEach(d=>modelos.push({...d.data(),id:d.id}));
 pintar();
}

function pintar(){
 const t = el("busqueda").value.toLowerCase();
 modelsBox.innerHTML="";
 modelos.filter(m=>
  (m.codigo||"").toLowerCase().includes(t)||
  (m.fabricante||"").toLowerCase().includes(t)||
  (m.modelo||"").toLowerCase().includes(t)
 ).forEach(m=>{
  modelsBox.innerHTML+=`
   <div class="card model">
    <img src="${m.imagen}">
    <b>${m.modelo}</b><br>
    ${m.fabricante}<br>${m.codigo}<br><br>
    <button onclick="borrar('${m.id}')">ðŸ—‘</button>
   </div>`;
 });
}

el("busqueda").oninput = pintar;

/* ===== MODAL ===== */
el("addBtn").onclick = ()=>modal.style.display="flex";
el("cancelBtn").onclick = ()=>modal.style.display="none";

/* ===== GUARDAR ===== */
el("saveBtn").onclick = async ()=>{
 let imagen="";
 const file = el("imgFile").files[0];
 if(file){
  const r=ref(storage,"modelos/"+Date.now());
  await uploadBytes(r,file);
  imagen=await getDownloadURL(r);
 } else imagen=el("imgUrl").value;

 await addDoc(collection(db,"modelos"),{
  codigo:el("codigo").value,
  fabricante:el("fabricante").value,
  modelo:el("modelo").value,
  imagen
 });

 modal.style.display="none";
 ["codigo","fabricante","modelo","imgUrl"].forEach(id=>el(id).value="");
 el("imgFile").value="";
 cargar();
};

window.borrar = async id=>{
 if(confirm("Â¿Borrar modelo?")){
  await deleteDoc(doc(db,"modelos",id));
  cargar();
 }
};

/* ===== UI ===== */
el("themeBtn").onclick = ()=>document.body.classList.toggle("dark");
el("verPass").onchange = ()=>el("password").type =
 el("password").type==="password"?"text":"password";

/* ===== ESCÃNER ===== */
el("scanBtn").onclick = async ()=>{
 scanner.style.display="flex";
 stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
 video.srcObject=stream;
 detector=new BarcodeDetector({formats:["ean_13","upc_a","ean_8"]});
 detectar();
};

el("closeScan").onclick = ()=>{
 scanner.style.display="none";
 if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
};

async function detectar(){
 if(!detector) return;
 const codes=await detector.detect(video);
 if(codes.length){
  const code=codes[0].rawValue;
  el("codigo").value=code;
  el("closeScan").click();
  buscarAPI(code);
 } else requestAnimationFrame(detectar);
}

async function buscarAPI(code){
 const r=await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
 const j=await r.json();
 if(j.status===1 && confirm("Datos encontrados. Â¿Usarlos?")){
  el("fabricante").value=j.product.brands||"";
  el("modelo").value=j.product.product_name||"";
  if(j.product.image_url) el("imgUrl").value=j.product.image_url;
 }
}
</script>

</body>
</html>
