<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Maikman Models Stock</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
--bg:#0f172a; --card:#020617; --text:#e5e7eb; --accent:#38bdf8;
--min-card-width: 260px;
}
body.light {
--bg:#f1f5f9; --card:#fff; --text:#020617; --accent:#2563eb;
}
* { box-sizing:border-box; transition:.3s; }
body { margin:0; font-family:system-ui; background:var(--bg); color:var(--text); }
header {
padding:20px; display:flex; justify-content:space-between;
align-items:center; font-size:22px; font-weight:bold;
}
button {
background:var(--accent); border:none; padding:8px 14px;
border-radius:6px; cursor:pointer; color:white;
}
input { padding:8px; border-radius:6px; border:none; width:100%; }
#login {
max-width:320px; margin:80px auto; background:var(--card);
padding:20px; border-radius:12px;
}
#app { display:none; }
#controls { display:flex; gap:10px; padding:20px; }
#grid {
display:grid;
grid-template-columns:repeat(auto-fill,minmax(var(--min-card-width),1fr));
gap:16px; padding:20px;
}
.card {
background:var(--card); border-radius:12px; padding:12px;
}
.card img {
width:100%; height:200px; object-fit:cover; border-radius:8px;
}
.badge {
position:absolute;
bottom:8px;
right:8px;
background:#dc2626;
color:white;
border-radius:50%;
width:28px;
height:28px;
display:flex;
align-items:center;
justify-content:center;
font-weight:bold;
}
.modal {
position:fixed; inset:0; background:rgba(0,0,0,.6);
display:none; align-items:center; justify-content:center;
}
.modal-content {
background:var(--card); padding:20px; width:340px;
border-radius:12px; display:flex; flex-direction:column; gap:10px;
}
#paintsModal .modal-content {
  width: 90%;
  max-width: 1400px;
  max-height: 92vh;
  overflow-y: auto;
  padding: 24px;
}
#paintsList {
  display: flex;
  flex-wrap: wrap;
  gap: 32px;
  margin: 20px 0;
}
.paints-column {
  flex: 1;
  min-width: 240px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.paints-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 6px 10px;
  border-radius: 6px;
  background: rgba(255,255,255,0.06);
  font-size: 14px;
}
.paints-item button {
  background: none;
  border: none;
  color: #ef4444;
  font-weight: bold;
  cursor: pointer;
  font-size: 18px;
  padding: 0 8px;
}
.paints-color {
  width: 28px;
  height: 28px;
  border: 1px solid #4b5563;
  border-radius: 6px;
  flex-shrink: 0;
}
#configModal .modal-content {
  width: 420px;
}
#configModal h4 {
  margin: 20px 0 10px;
  font-size: 18px;
}
#configModal label {
  display: block;
  margin-bottom: 12px;
}
#configModal input[type="number"] {
  width: 90px;
  padding: 6px;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
<h2>Acceso</h2>
<input id="email" type="email" placeholder="Email"><br><br>
<input id="password" type="password" placeholder="Contrase√±a">
<label><input type="checkbox" onclick="verPassword()"> Ver contrase√±a</label><br><br>
<button onclick="login()">Entrar</button>
<p id="error" style="color:red;"></p>
</div>

<!-- APP -->
<div id="app">
<header>
üì¶ Maikman Models
<button onclick="openConfigModal()">‚öôÔ∏è</button>
</header>
<div id="controls">
<input id="search" placeholder="Buscar por c√≥digo, fabricante o modelo">
<button onclick="openModal()">‚ûï A√±adir nuevo modelo</button>
<button onclick="logout()">Salir</button>
</div>
<div id="grid"></div>
</div>

<!-- MODAL MODELO -->
<div id="modal" class="modal">
<div class="modal-content">
<h3 id="modalTitle">Nuevo modelo</h3>
<input id="codigo" placeholder="C√≥digo">
<input id="fabricante" placeholder="Fabricante">
<input id="modelo" placeholder="Modelo">
<b>Imagen</b>
<input id="fotoURL" placeholder="URL de la imagen (opcional)">
<input type="file" id="fotoFile" accept="image/*">
<button onclick="guardarModelo()">Guardar</button>
<button onclick="closeModal()">Cancelar</button>
</div>
</div>

<!-- MODAL PINTURAS -->
<div id="paintsModal" class="modal">
<div class="modal-content">
<h3>Pinturas Tamiya para <span id="currentModelName"></span></h3>
<input id="newPaints" placeholder="Ej: 9, h2, x-1, ts-14 (separados por coma)">
<div id="paintsList"></div>
<div style="display:flex; gap:12px; margin-top:20px;">
  <button onclick="savePaints()" style="flex:1; padding:12px;">Guardar cambios</button>
  <button onclick="closePaintsModal()" style="flex:1; padding:12px;">Cerrar</button>
</div>
</div>
</div>

<!-- MODAL CONFIGURACI√ìN -->
<div id="configModal" class="modal">
<div class="modal-content">
<h3>Configuraci√≥n</h3>
<div>
<h4>Tema</h4>
<button onclick="toggleTheme()">üåì Cambiar tema (actual: <span id="currentTheme">Oscuro</span>)</button>
</div>
<div>
<h4>Modelos</h4>
<label>Tarjetas por fila (aprox.): <input id="configCardsPerRow" type="number" min="1" max="8" step="1"></label>
</div>
<div>
<h4>Pinturas</h4>
<label>Items por columna: <input id="configItemsPerColumn" type="number" min="5" max="30" step="1"></label>
</div>
<div>
<h4>Datos</h4>
<button onclick="exportarModelos()">Exportar a Excel</button>
<label for="importFile">Importar desde Excel: <input type="file" id="importFile" accept=".xlsx,.xls"></label>
<button onclick="importarModelos()">Importar</button>
</div>
<button onclick="saveConfig()">Guardar</button>
<button onclick="closeConfigModal()">Cancelar</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAtWLxQfVqsEt8fLZkGRN-3zSHuzKMUTk8",
  authDomain: "maikmanmodelsstock.firebaseapp.com",
  projectId: "maikmanmodelsstock",
  storageBucket: "maikmanmodelsstock.appspot.com",
  messagingSenderId: "871520809912",
  appId: "1:871520809912:web:4042f15ef200832a95d54d"
};

const appFB = initializeApp(firebaseConfig);
const auth = getAuth(appFB);
const db = getFirestore(appFB);
const storage = getStorage(appFB);

const loginBox = document.getElementById("login");
const appBox = document.getElementById("app");
const modal = document.getElementById("modal");
const paintsModal = document.getElementById("paintsModal");
const configModal = document.getElementById("configModal");
const grid = document.getElementById("grid");
const search = document.getElementById("search");

let modelos = [];
let editId = null;
let currentModel = null;

let itemsPerColumn = parseInt(localStorage.getItem('itemsPerColumn')) || 10;
let cardsPerRow = parseInt(localStorage.getItem('cardsPerRow')) || 4;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 1. Definimos applyConfig ANTES de llamarla
function applyConfig() {
  document.documentElement.style.setProperty('--min-card-width', `calc((100% - 40px) / ${cardsPerRow} - 16px)`);
  const theme = localStorage.getItem('theme') || 'dark';
  document.body.classList.toggle('light', theme === 'light');
  const currentThemeEl = document.getElementById('currentTheme');
  if (currentThemeEl) {
    currentThemeEl.innerText = theme === 'light' ? 'Claro' : 'Oscuro';
  }
}

// 2. Llamamos DESPU√âS de definirla
applyConfig();

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Gunze ‚Üí Tamiya
const gunzeToTamiya = {
'1': 'X-2', 
  '2': 'X-1', 
  '3': 'X-7', 
  '4': 'X-8', 
  '5': 'X-4', 
  '6': 'X-5', 
  '7': 'X-9', 
  '8': 'X-11', 
  '9': 'X-12', 
  '10': 'XF-6', 
  '11': 'XF-2', 
  '12': 'XF-1', 
  '13': 'XF-7', 
  '14': 'X-6', 
  '15': 'X-3', 
  '16': 'XF-4', 
  '17': 'XF-64', 
  '18': 'X-10', 
  '19': 'X-17', 
  '20': 'X-10',
  '21': 'X-2', 
  '22': 'XF-20', 
  '23': 'XF-7', 
  '25': 'X-14', 
  '28': 'LP-40', 
  '30': 'X-22', 
  '33': 'XF-1', 
  '47': 'X-27', 
  '49': 'X-26',  
  '50': 'X-23',
  '51': 'XF-12', 
  '52': 'XF-53', 
  '53': 'XF-53', 
  '59': 'X-6', 
  '62': 'XF-2', 
  '76': 'XF-84', 
  '88': 'X-13',
  '90': 'X-27', 
  '91': 'X-24', 
  '92': 'X-26', 
  '93': 'X-23', 
  '94': 'X-25', 
  '95': 'XF-19'
};

const tamiyaToGunze = {};
for (const [g, t] of Object.entries(gunzeToTamiya)) {
  tamiyaToGunze[t] = g;
}

// Diccionario de pinturas
const paintsDict = {
            'X-1': { name: 'Negro', color: '#000000' },
            'X-2': { name: 'Blanco', color: '#FFFFFF' },
            'X-3': { name: 'Azul Real', color: '#003087' },
            'X-4': { name: 'Azul', color: '#0055A4' },
            'X-5': { name: 'Verde', color: '#008000' },
            'X-6': { name: 'Naranja', color: '#FF6200' },
            'X-7': { name: 'Rojo', color: '#FF0000' },
            'X-8': { name: 'Amarillo Lim√≥n', color: '#FFFF00' },
            'X-9': { name: 'Marr√≥n', color: '#4A2C2A' },
            'X-10': { name: 'Gris Ca√±√≥n', color: '#3F3F3F' },
            'X-11': { name: 'Plateado Cromo', color: '#C0C0C0' },
            'X-12': { name: 'Dorado', color: '#FFD700' },
            'X-13': { name: 'Azul Met√°lico', color: '#0047AB' },
            'X-14': { name: 'Azul Cielo', color: '#87CEEB' },
            'X-15': { name: 'Verde Claro', color: '#90EE90' },
            'X-16': { name: 'P√∫rpura', color: '#800080' },
            'X-17': { name: 'Rosa', color: '#FF69B4' },
            'X-18': { name: 'Negro Satinado', color: '#2F2F2F' },
            'X-19': { name: 'Humo', color: '#6A6A6A' },
            'X-21': { name: 'Base Plana', color: '#D3D3D3' },
            'X-22': { name: 'Transparente', color: '#F5F6F5' },
            'X-23': { name: 'Azul Claro', color: '#ADD8E6' },
            'X-25': { name: 'Verde Claro', color: '#98FB98' },
            'X-26': { name: 'Naranja Claro', color: '#FFA500' },
            'X-27': { name: 'Rojo Claro', color: '#FF4040' },
            'X-28': { name: 'Verde Parque', color: '#355E3B' },
            'X-31': { name: 'Dorado Titanio', color: '#D4A017' },
            'X-32': { name: 'Plateado Titanio', color: '#B7B7B7' },
            'X-33': { name: 'Bronce', color: '#8C7853' },
            'X-34': { name: 'Marr√≥n Met√°lico', color: '#6F4E37' },
            'XF-1': { name: 'Negro Mate', color: '#1C2526' },
            'XF-2': { name: 'Blanco Mate', color: '#E8ECEF' },
            'XF-3': { name: 'Amarillo Mate', color: '#FFC107' },
            'XF-4': { name: 'Amarillo Verdoso Mate', color: '#9ACD32' },
            'XF-5': { name: 'Verde Mate', color: '#355E3B' },
            'XF-6': { name: 'Cobre Mate', color: '#B87333' },
            'XF-7': { name: 'Rojo Mate', color: '#8B0000' },
            'XF-8': { name: 'Azul Mate', color: '#003087' },
            'XF-9': { name: 'Marr√≥n Casco Mate', color: '#4A3728' },
            'XF-10': { name: 'Marr√≥n Mate', color: '#8B4513' },
            'XF-11': { name: 'Verde J.N. Mate', color: '#2E4A2E' },
            'XF-12': { name: 'Gris J.N. Mate', color: '#6B7280' },
            'XF-13': { name: 'Verde J.A. Mate', color: '#3A5F3A' },
            'XF-14': { name: 'Gris J.A. Mate', color: '#6D8299' },
            'XF-15': { name: 'Carne Mate', color: '#F4C7B8' },
            'XF-16': { name: 'Aluminio Mate', color: '#A9A9A9' },
            'XF-17': { name: 'Azul Marino Mate', color: '#2C3E50' },
            'XF-18': { name: 'Gris Medio Mate', color: '#6B7280' },
            'XF-19': { name: 'Gris Cielo Mate', color: '#B0C4DE' },
            'XF-20': { name: 'Gris Medio Mate', color: '#808080' },
            'XF-21': { name: 'Cielo Mate', color: '#87CEEB' },
            'XF-22': { name: 'Gris RLM Mate', color: '#5A6A62' },
            'XF-23': { name: 'Azul Claro Mate', color: '#ADD8E6' },
            'XF-24': { name: 'Gris Oscuro Mate', color: '#4B5E40' },
            'XF-25': { name: 'Verde Claro Mate', color: '#98FB98' },
            'XF-26': { name: 'Verde Oscuro Mate', color: '#2E4A2E' },
            'XF-27': { name: 'Verde Negro Mate', color: '#1A2521' },
            'XF-28': { name: 'Cobre Oscuro Mate', color: '#6F4E37' },
            'XF-29': { name: 'Gris Verdoso Mate', color: '#5A6A62' },
            'XF-49': { name: 'Caqui Mate', color: '#8A7F2D' },
            'XF-50': { name: 'Azul Campo Mate', color: '#4682B4' },
            'XF-51': { name: 'Caqui Drab Mate', color: '#6B4E31' },
            'XF-52': { name: 'Tierra Mate', color: '#5C4033' },
            'XF-53': { name: 'Gris Neutral Mate', color: '#808080' },
            'XF-54': { name: 'Gris Marino Mate', color: '#536878' },
            'XF-55': { name: 'Tierra Cubierta Mate', color: '#8B5A2B' },
            'XF-56': { name: 'Gris Met√°lico Mate', color: '#6A6A6A' },
            'XF-57': { name: 'Buff Mate', color: '#F4A460' },
            'XF-58': { name: 'Verde Olivo Mate', color: '#4A7043' },
            'XF-59': { name: 'Amarillo Desierto Mate', color: '#DEB887' },
            'XF-60': { name: 'Amarillo Oscuro Mate', color: '#B8860B' },
            'XF-61': { name: 'Verde Oscuro Mate', color: '#2F4F2F' },
            'XF-62': { name: 'Verde Olivo Drab Mate', color: '#4B5320' },
            'XF-63': { name: 'Gris Alem√°n Mate', color: '#4F4F4F' },
            'XF-64': { name: 'Marr√≥n Rojizo Mate', color: '#5C2F2F' },
            'XF-65': { name: 'Gris Mate', color: '#6B7280' },
            'XF-66': { name: 'Gris Claro Mate', color: '#D3D3D3' },
            'XF-67': { name: 'Verde NATO Mate', color: '#3A403B' },
            'XF-68': { name: 'Marr√≥n NATO Mate', color: '#4A3728' },
            'XF-69': { name: 'Negro NATO Mate', color: '#1C2526' },
            'XF-70': { name: 'Gris Oscuro Mate', color: '#3F4F3F' },
            'XF-71': { name: 'Verde Cabina Mate', color: '#4A7043' },
            'XF-72': { name: 'Marr√≥n JGSDF Mate', color: '#5C4033' },
            'XF-73': { name: 'Verde Oscuro JGSDF Mate', color: '#2E4A2E' },
            'XF-74': { name: 'Verde Olivo JGSDF Mate', color: '#4A7043' },
            'XF-75': { name: 'Gris IJN Mate', color: '#6B7280' },
            'XF-76': { name: 'Gris Verde IJN Mate', color: '#5A6A62' },
            'XF-77': { name: 'Gris Marino IJN Mate', color: '#536878' },
            'XF-78': { name: 'Madera Mate', color: '#8B5A2B' },
            'XF-79': { name: 'Lino Mate', color: '#F5F5DC' },
            'XF-80': { name: 'Gris Real Mate', color: '#4682B4' },
            'XF-81': { name: 'Verde Oscuro RAF Mate', color: '#2F4F2F' },
            'XF-82': { name: 'Gris Oc√©ano RAF Mate', color: '#6B7280' },
            'XF-83': { name: 'Gris Marino RAF Mate', color: '#536878' },
            'XF-84': { name: 'Marr√≥n Oscuro Mate', color: '#4A3728' },
            'XF-85': { name: 'Negro Goma Mate', color: '#1C2526' },
            'XF-86': { name: 'Transparente Mate', color: '#F5F6F5' },
            'LP-1': { name: 'Negro', color: '#000000' },
            'LP-2': { name: 'Blanco', color: '#FFFFFF' },
            'LP-3': { name: 'Azul', color: '#0000FF' },
            'LP-4': { name: 'Amarillo', color: '#FFFF00' },
            'LP-5': { name: 'Rojo', color: '#FF0000' },
            'LP-6': { name: 'Plateado', color: '#C0C0C0' },
            'LP-7': { name: 'Dorado', color: '#FFD700' },
            'LP-8': { name: 'Naranja', color: '#FF4500' },
            'LP-9': { name: 'Transparente', color: '#F5F6F5' },
            'LP-10': { name: 'Negro Matejo', color: '#1C2526' },
            'LP-11': { name: 'Plateado (Hoja)', color: '#B7B7B7' },
            'LP-12': { name: 'Gris IJN', color: '#6B7280' },
            'LP-13': { name: 'Gris IJN (Sajo)', color: '#536878' },
            'LP-14': { name: 'Gris IJN (Mate)', color: '#5A6A62' },
            'LP-15': { name: 'Verde Matejo', color: '#008000' },
            'LP-16': { name: 'Marr√≥n Matejo', color: '#8B4513' },
            'LP-17': { name: 'Verde Mate', color: '#355E3B' },
            'LP-18': { name: 'Marr√≥n Mate', color: '#4A3728' },
            'LP-19': { name: 'Gris Ca√±√≥n', color: '#3F4F4F' },
            'LP-20': { name: 'Gris Claro', color: '#D3D3D3' },
            'LP-21': { name: 'Verde Italiano', color: '#2E4A2E' },
            'LP-22': { name: 'Rojo Italiano', color: '#8B0000' },
            'LP-23': { name: 'Azul Claro', color: '#ADD8E6' },
            'LP-24': { name: 'Azul Marino', color: '#2C3E50' },
            'LP-25': { name: 'Marr√≥n (JGSDF)', color: '#5C4033' },
            'LP-26': { name: 'Verde Oscuro (JGSDF)', color: '#2E4A2E' },
            'LP-27': { name: 'Gris Alem√°n', color: '#4F4F4F' },
            'LP-28': { name: 'Verde Olivo', color: '#4A7043' },
            'LP-29': { name: 'Verde Casco', color: '#2F4F2F' },
            'LP-30': { name: 'Blanco Mate', color: '#E8ECEF' },
            'LP-31': { name: 'Plateado Chispa', color: '#A9A9A9' },
            'LP-32': { name: 'Gris Claro (IJN)', color: '#B0C4DE' },
            'LP-33': { name: 'Gris Kure (IJN)', color: '#6D8299' },
            'LP-34': { name: 'Azul Met√°lico', color: '#0047AB' },
            'LP-35': { name: 'Base Plana', color: '#D3D3D3' },
            'LP-36': { name: 'Azul Oscuro', color: '#003087' },
            'LP-37': { name: 'Gris Claro Mate', color: '#B0C4DE' },
            'LP-38': { name: 'Mica Plateada', color: '#C0C0C0' },
            'LP-39': { name: 'Amarillo Brillante', color: '#FFC107' },
            'LP-40': { name: 'Negro Met√°lico', color: '#2F2F2F' },
            'LP-41': { name: 'Rojo Mica', color: '#8B0000' },
            'LP-42': { name: 'Azul Mica', color: '#003087' },
            'LP-43': { name: 'Azul Claro', color: '#4682B4' },
            'LP-44': { name: 'Verde Met√°lico', color: '#008080' },
            'LP-45': { name: 'Verde Perla', color: '#2E8B57' },
            'LP-46': { name: 'Rojo Transparente', color: '#FF4040' },
            'LP-47': { name: 'Azul Transparente', color: '#4169E1' },
            'LP-48': { name: 'Verde Transparente', color: '#32CD32' },
            'LP-49': { name: 'Amarillo Transparente', color: '#FFFF99' },
            'LP-50': { name: 'Naranja Transparente', color: '#FFA500' },
            'LP-51': { name: 'Humo', color: '#6A6A6A' },
            'LP-52': { name: 'Rojo Met√°lico', color: '#8B0000' },
            'LP-53': { name: 'Gris Titanio', color: '#B7B7B7' },
            'LP-54': { name: 'Verde Oscuro Mate', color: '#2F4F2F' },
            'LP-55': { name: 'Gris Oscuro Mate', color: '#3F4F4F' },
            'LP-56': { name: 'Caqui Mate', color: '#8A7F2D' },
            'LP-57': { name: 'Amarillo Desierto Mate', color: '#DEB887' },
            'LP-58': { name: 'Verde NATO Mate', color: '#3A403B' },
            'LP-59': { name: 'Marr√≥n Nato Mate', color: '#4A3728' },
            'LP-60': { name: 'Gris Met√°lico', color: '#6A6A6A' },
            'LP-61': { name: 'Gris Mate (JGSDF)', color: '#6B7280' },
            'LP-62': { name: 'Tierra Mate', color: '#5C4033' },
            'LP-63': { name: 'Verde Mate (IJN)', color: '#2E4A2E' },
            'LP-64': { name: 'Negro Mate Goma', color: '#1C2526' },
            'LP-65': { name: 'Gris Mate', color: '#808080' },
            'LP-66': { name: 'Gris Claro Mate', color: '#D3D3D3' },
            'LP-67': { name: 'Madera Mate', color: '#8B5A2B' },
            'LP-68': { name: 'Amarillo Mate', color: '#FFC107' },
            'LP-69': { name: 'Verde Olivo Mate', color: '#4A7043' },
            'LP-70': { name: 'Rojo Mate', color: '#8B0000' },
            'LP-71': { name: 'Azul Mate', color: '#003087' },
            'LP-72': { name: 'Marr√≥n Mate', color: '#8B4513' },
            'LP-73': { name: 'Gris Cielo Mate', color: '#B0C4DE' },
            'LP-74': { name: 'Bronce Mate', color: '#8C7853' },
            'LP-75': { name: 'Verde Mica', color: '#2E8B57' },
            'LP-76': { name: 'Verde Mica', color: '#2E8B57' },
            'TS-1': { name: 'Rojo Marr√≥n', color: '#8B0000' },
            'TS-2': { name: 'Verde Oscuro', color: '#2F4F2F' },
            'TS-3': { name: 'Marr√≥n Oscuro', color: '#4A3728' },
            'TS-4': { name: 'Gris Alem√°n', color: '#4F4F4F' },
            'TS-5': { name: 'Verde Olivo Mate', color: '#4A7043' },
            'TS-6': { name: 'Negro Mate', color: '#1C2526' },
            'TS-7': { name: 'Amarillo Brillante', color: '#FFC107' },
            'TS-8': { name: 'Rojo Italiano', color: '#8B0000' },
            'TS-9': { name: 'Marr√≥n Italiano', color: '#5C4033' },
            'TS-10': { name: 'Azul Franc√©s', color: '#003087' },
            'TS-11': { name: 'Granate', color: '#800020' },
            'TS-12': { name: 'Naranja', color: '#FF6200' },
            'TS-13': { name: 'Transparente', color: '#F5F6F5' },
            'TS-14': { name: 'Negro', color: '#000000' },
            'TS-15': { name: 'Azul', color: '#0000FF' },
            'TS-16': { name: 'Amarillo', color: '#FFFF00' },
            'TS-17': { name: 'Aluminio Brillante', color: '#A9A9A9' },
            'TS-18': { name: 'Rojo Met√°lico', color: '#8B0000' },
            'TS-19': { name: 'Azul Met√°lico', color: '#0047AB' },
            'TS-20': { name: 'Verde Met√°lico', color: '#008080' },
            'TS-21': { name: 'Dorado', color: '#FFD700' },
            'TS-22': { name: 'Gris Claro', color: '#D3D3D3' },
            'TS-23': { name: 'Azul Claro', color: '#ADD8E6' },
            'TS-24': { name: 'P√∫rpura', color: '#800080' },
            'TS-25': { name: 'Rosa', color: '#FF69B4' },
            'TS-26': { name: 'Blanco Puro', color: '#FFFFFF' },
            'TS-27': { name: 'Blanco Mate', color: '#E8ECEF' },
            'TS-28': { name: 'Verde Olivo Mate', color: '#4A7043' },
            'TS-29': { name: 'Rojo Mate', color: '#8B0000' },
            'TS-30': { name: 'Plateado', color: '#C0C0C0' },
            'TS-31': { name: 'Naranja Brillante', color: '#FFA500' },
            'TS-32': { name: 'Gris Haze', color: '#6B7280' },
            'TS-33': { name: 'Gris Mate', color: '#808080' },
            'TS-34': { name: 'Verde Camuflaje', color: '#2E4A2E' },
            'TS-35': { name: 'Verde Parque', color: '#355E3B' },
            'TS-36': { name: 'Rojo Fluorescente', color: '#FF4040' },
            'TS-37': { name: 'Gris Lava', color: '#4F4F4F' },
            'TS-38': { name: 'Gris Ca√±√≥n', color: '#3F4F3F' },
            'TS-39': { name: 'Rojo Mica', color: '#8B0000' },
            'TS-40': { name: 'Negro Met√°lico', color: '#2F2F2F' },
            'TS-41': { name: 'Rojo Coral', color: '#FF4040' },
            'TS-42': { name: 'Gris Claro Mica', color: '#B0C4DE' },
            'TS-43': { name: 'Verde Brillante', color: '#008000' },
            'TS-44': { name: 'Azul Brillante', color: '#4169E1' },
            'TS-45': { name: 'Blanco Perla', color: '#F5F5DC' },
            'TS-46': { name: 'Amarillo Claro', color: '#FFFF99' },
            'TS-47': { name: 'Amarillo Cromo', color: '#FFC107' },
            'TS-48': { name: 'Gris Ca√±√≥n Mate', color: '#3F4F4F' },
            'TS-49': { name: 'Rojo Brillante', color: '#FF0000' },
            'TS-50': { name: 'Azul Mica', color: '#003087' },
            'TS-51': { name: 'Azul Racing', color: '#0047AB' },
            'TS-52': { name: 'P√∫rpura Caramelo', color: '#800080' },
            'TS-53': { name: 'Azul Oc√©ano Profundo', color: '#2C3E50' },
            'TS-54': { name: 'Gris Claro Met√°lico', color: '#B7B7B7' },
            'TS-55': { name: 'Azul Oscuro Mate', color: '#003087' },
            'TS-56': { name: 'Naranja Brillante Mate', color: '#FFA500' },
            'TS-57': { name: 'Azul Gris√°ceo Mate', color: '#6D8299' },
            'TS-58': { name: 'Naranja Perla Claro', color: '#FFA500' },
            'TS-59': { name: 'Rojo Perla Claro', color: '#FF4040' },
            'TS-60': { name: 'Verde Perla', color: '#2E8B57' },
            'TS-61': { name: 'Verde NATO', color: '#3A403B' },
            'TS-62': { name: 'Marr√≥n NATO', color: '#4A3728' },
            'TS-63': { name: 'Negro NATO', color: '#1C2526' },
            'TS-64': { name: 'Mica Verde Oscuro', color: '#2E4A2E' },
            'TS-65': { name: 'Plateado Perla', color: '#C0C0C0' },
            'TS-66': { name: 'Gris Kure', color: '#6D8299' },
            'TS-67': { name: 'Gris Sasebo', color: '#536878' },
            'TS-68': { name: 'Marr√≥n Madera', color: '#8B5A2B' },
            'TS-69': { name: 'Gris Lino', color: '#F5F5DC' },
            'TS-70': { name: 'Verde Olivo JGSDF', color: '#4A7043' },
            'TS-71': { name: 'Humo', color: '#6A6A6A' },
            'TS-72': { name: 'Transparente Azul', color: '#4169E1' },
            'TS-73': { name: 'Transparente Naranja', color: '#FFA500' },
            'TS-74': { name: 'Transparente Rojo', color: '#FF4040' },
            'TS-75': { name: 'Champ√°n Dorado', color: '#D4A017' },
            'TS-76': { name: 'Gris Mica', color: '#6B7280' },
            'TS-77': { name: 'Gris Mate', color: '#808080' },
            'TS-78': { name: 'Gris Campo', color: '#6B7280' },
            'TS-79': { name: 'Negro Satinado', color: '#2F2F2F' },
            'TS-80': { name: 'Base Plana', color: '#D3D3D3' },
            'TS-81': { name: 'Azul Real Mate', color: '#003087' },
            'TS-82': { name: 'Negro Goma Mate', color: '#1C2526' },
            'TS-83': { name: 'Plateado Met√°lico', color: '#A9A9A9' },
            'TS-84': { name: 'Dorado Met√°lico', color: '#FFD700' },
            'TS-85': { name: 'Rojo Ferrari Brillante', color: '#FF0000' },
            'TS-86': { name: 'Rojo Puro Brillante', color: '#FF0000' },
            'TS-87': { name: 'Gris Titanio', color: '#B7B7B7' },
            'TS-88': { name: 'Plateado Titanio', color: '#B7B7B7' },
            'TS-89': { name: 'Azul Perla', color: '#4682B4' },
            'TS-90': { name: 'Marr√≥n Mate JGSDF', color: '#5C4033' },
            'TS-91': { name: 'Verde Oscuro JGSDF', color: '#2E4A2E' },
            'TS-92': { name: 'Naranja Met√°lico', color: '#FFA500' },
            'TS-93': { name: 'Azul Puro Brillante', color: '#0000FF' },
            'TS-94': { name: 'Gris Met√°lico', color: '#6A6A6A' },
            'TS-95': { name: 'Rojo Met√°lico Puro', color: '#8B0000' },
            'TS-96': { name: 'Naranja Fluorescente', color: '#FF4500' },
            'TS-97': { name: 'Amarillo Perla', color: '#FFFF99' },
            'TS-98': { name: 'Amarillo Puro Brillante', color: '#FFFF00' },
            'TS-99': { name: 'Marr√≥n IJN Mate', color: '#5C4033' },
            'TS-100': { name: 'Verde Mate IJN', color: '#2E4A2E' }
  // A√±ade m√°s si los necesitas
};

/* LOGIN */
window.login = () =>
  signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value)
    .catch(() => document.getElementById('error').innerText = "Credenciales incorrectas");

window.logout = () => signOut(auth);

onAuthStateChanged(auth, user => {
  loginBox.style.display = user ? "none" : "block";
  appBox.style.display = user ? "block" : "none";
  if (user) cargarModelos();
});

/* UI */
window.toggleTheme = () => {
  document.body.classList.toggle("light");
  localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
  document.getElementById('currentTheme').innerText = document.body.classList.contains('light') ? 'Claro' : 'Oscuro';
};

window.verPassword = () => {
  const pw = document.getElementById('password');
  pw.type = pw.type === "password" ? "text" : "password";
};

/* CONFIG */
window.openConfigModal = () => {
  configModal.style.display = 'flex';
  document.getElementById('configCardsPerRow').value = cardsPerRow;
  document.getElementById('configItemsPerColumn').value = itemsPerColumn;
};

window.closeConfigModal = () => configModal.style.display = 'none';

window.saveConfig = () => {
  cardsPerRow = Math.max(1, Math.min(8, parseInt(document.getElementById('configCardsPerRow').value) || 4));
  itemsPerColumn = Math.max(5, Math.min(30, parseInt(document.getElementById('configItemsPerColumn').value) || 10));
  localStorage.setItem('cardsPerRow', cardsPerRow);
  localStorage.setItem('itemsPerColumn', itemsPerColumn);
  applyConfig();
  closeConfigModal();
  pintar();
};

/* MODAL MODELO */
window.openModal = m => {
  modal.style.display = "flex";
  document.getElementById('modalTitle').innerText = m ? "Editar modelo" : "Nuevo modelo";
  document.getElementById('codigo').value = m?.codigo || "";
  document.getElementById('fabricante').value = m?.fabricante || "";
  document.getElementById('modelo').value = m?.modelo || "";
  document.getElementById('fotoURL').value = "";
  document.getElementById('fotoFile').value = "";
  editId = m?.id || null;
};

window.closeModal = () => modal.style.display = "none";

/* MODAL PINTURAS */
window.openPaintsModal = m => {
  if (!m || !m.id) return alert("Error: Modelo inv√°lido");
  currentModel = { ...m, paints: Array.isArray(m.paints) ? [...m.paints] : [] };
  paintsModal.style.display = "flex";
  document.getElementById("currentModelName").innerText =
    (m.codigo ? m.codigo + " ‚Äì " : "") + (m.modelo || "Modelo sin nombre");
  renderPaintsList();
};

window.closePaintsModal = () => paintsModal.style.display = "none";

function sortPaints(codes) {
  const seriesOrder = { 'X':1, 'XF':2, 'TS':3, 'LP':4 };
  return [...codes].sort((a,b) => {
    const pa = a.toUpperCase().split('-');
    const pb = b.toUpperCase().split('-');
    const sa = seriesOrder[pa[0]] || 99;
    const sb = seriesOrder[pb[0]] || 99;
    if (sa !== sb) return sa - sb;
    return (parseInt(pa[1]) || 9999) - (parseInt(pb[1]) || 9999);
  });
}

function renderPaintsList() {
  const list = document.getElementById("paintsList");
  list.innerHTML = "";
  const paints = Array.isArray(currentModel?.paints) ? currentModel.paints : [];
  if (paints.length === 0) {
    list.innerHTML = '<p style="color:#9ca3af;text-align:center;">A√∫n no hay pinturas a√±adidas</p>';
    return;
  }
  const sortedPaints = sortPaints(paints);
  const columns = [];
  for (let i = 0; i < sortedPaints.length; i += itemsPerColumn) {
    columns.push(sortedPaints.slice(i, i + itemsPerColumn));
  }
  columns.forEach(columnPaints => {
    const colDiv = document.createElement("div");
    colDiv.className = "paints-column";
    columnPaints.forEach(code => {
      const p = paintsDict[code];
      if (!p) return;
      const gunze = tamiyaToGunze[code] || '';
      const displayCode = gunze ? `${gunze} / ${code}` : code;
      const item = document.createElement("div");
      item.className = "paints-item";
      item.innerHTML = `
        <button class="delete-btn">X</button>
        <div class="paints-color" style="background:${p.color};"></div>
        <span style="font-family:monospace; min-width:80px;">${displayCode}</span>
        <span>${p.name}</span>
      `;
      item.querySelector('.delete-btn').addEventListener('click', () => {
        const idx = currentModel.paints.indexOf(code);
        if (idx > -1) currentModel.paints.splice(idx, 1);
        renderPaintsList();
      });
      colDiv.appendChild(item);
    });
    list.appendChild(colDiv);
  });
}

window.savePaints = async () => {
  if (!currentModel || !currentModel.id) {
    alert("Error: No se encontr√≥ el modelo.");
    closePaintsModal();
    return;
  }
  const input = document.getElementById("newPaints").value.trim();
  if (input) {
    const newCodes = input.split(',').map(normalizeCode)
      .filter(code => code && paintsDict[code] && !currentModel.paints.includes(code));
    if (newCodes.length > 0) {
      currentModel.paints.push(...newCodes);
      document.getElementById("newPaints").value = "";
      renderPaintsList();
    }
  }
  await updateDoc(doc(db, "modelos", currentModel.id), { paints: currentModel.paints || [] });
  closePaintsModal();
  cargarModelos();
};

function normalizeCode(c) {
  if (!c) return '';
  c = c.trim().toUpperCase().replace(/ /g, '').replace(/^H/i, '');
  if (/^\d+$/.test(c)) {
    const tamiya = gunzeToTamiya[c];
    if (tamiya) return tamiya;
  }
  if (!c.includes('-')) {
    const match = c.match(/^([A-Z]+)([\d]+)/);
    if (match) c = match[1] + '-' + match[2];
  }
  return c;
}

/* DATA */
async function cargarModelos() {
  modelos = [];
  const snap = await getDocs(collection(db, "modelos"));
  snap.forEach(d => modelos.push({ id: d.id, ...d.data() }));
  pintar();
}

function pintar() {
  const q = search.value.toLowerCase();
  grid.innerHTML = "";
  const filtered = modelos.filter(m =>
    (m.codigo || "").toLowerCase().includes(q) ||
    (m.fabricante || "").toLowerCase().includes(q) ||
    (m.modelo || "").toLowerCase().includes(q)
  );
  filtered.forEach(m => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div style="position:relative">
        <img src="${m.foto || ''}" style="width:100%; height:200px; object-fit:cover; border-radius:8px;">
        ${m.duplicados > 1 ? `<div class="badge">${m.duplicados}</div>` : ''}
      </div>
      <b>${m.modelo || "Sin nombre"}</b><br>
      <small>${m.fabricante || "‚Äî"} ¬∑ ${m.codigo || "‚Äî"}</small><br><br>
    `;
    const btnEdit = document.createElement('button');
    btnEdit.textContent = '‚úèÔ∏è';
    btnEdit.onclick = () => openModal(m);
    const btnDelete = document.createElement('button');
    btnDelete.textContent = 'üóëÔ∏è';
    btnDelete.onclick = () => borrar(m.id);
    const btnPaint = document.createElement('button');
    btnPaint.textContent = 'üé®';
    btnPaint.onclick = () => openPaintsModal(m);
    card.append(btnEdit, btnDelete, btnPaint);
    grid.appendChild(card);
  });
}

/* SAVE MODELO */
window.guardarModelo = async () => {
  const existente = modelos.find(m =>
    (m.codigo && m.codigo === document.getElementById('codigo').value) ||
    (
      m.fabricante?.toLowerCase() === document.getElementById('fabricante').value.toLowerCase() &&
      m.modelo?.toLowerCase() === document.getElementById('modelo').value.toLowerCase()
    )
  );
  if (existente && !editId) {
    if (!confirm("Este modelo ya existe.\n¬øQuieres a√±adir un duplicado?")) return;
    await updateDoc(doc(db, "modelos", existente.id), { duplicados: (existente.duplicados || 1) + 1 });
    closeModal();
    cargarModelos();
    return;
  }
  let fotoFinal = "";
  if (document.getElementById('fotoURL').value) fotoFinal = document.getElementById('fotoURL').value;
  else if (document.getElementById('fotoFile').files[0]) {
    const r = ref(storage, "modelos/" + Date.now());
    await uploadBytes(r, document.getElementById('fotoFile').files[0]);
    fotoFinal = await getDownloadURL(r);
  }
  const data = {
    codigo: document.getElementById('codigo').value,
    fabricante: document.getElementById('fabricante').value,
    modelo: document.getElementById('modelo').value,
    foto: fotoFinal,
    duplicados: 1
  };
  if (editId) await updateDoc(doc(db, "modelos", editId), data);
  else await addDoc(collection(db, "modelos"), data);
  closeModal();
  cargarModelos();
};

window.borrar = async id => {
  if (confirm("¬øBorrar modelo?")) {
    await deleteDoc(doc(db, "modelos", id));
    cargarModelos();
  }
};

search.addEventListener("input", pintar);

/* EXPORT / IMPORT */
window.exportarModelos = () => {
  const data = modelos.map(m => ({
    C√≥digo: m.codigo || '',
    Fabricante: m.fabricante || '',
    Modelo: m.modelo || '',
    Imagen: m.foto || '',
    Pinturas: (m.paints || []).join(',')
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Modelos");
  XLSX.writeFile(wb, 'maikman_models.xlsx');
};

window.importarModelos = async () => {
  const file = document.getElementById('importFile').files[0];
  if (!file) return alert('Selecciona un archivo Excel.');

  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const wb = XLSX.read(e.target.result, { type: 'binary' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws, { 
        header: ['C√≥digo', 'Fabricante', 'Modelo', 'Imagen', 'Pinturas'] 
      }).slice(1);

      if (data.length === 0) {
        alert('El archivo Excel est√° vac√≠o o no tiene datos v√°lidos.');
        return;
      }

      let imported = 0;
      let updated = 0;

      for (const row of data) {
        const codigo = (row['C√≥digo'] || '').trim();
        const fabricante = (row['Fabricante'] || '').trim();
        const modelo = (row['Modelo'] || '').trim();
        const foto = (row['Imagen'] || '').trim();
        const pinturasStr = (row['Pinturas'] || '').trim();

        const paints = pinturasStr 
          ? pinturasStr.split(',').map(c => normalizeCode(c.trim())).filter(code => code && paintsDict[code]) 
          : [];

        const existing = modelos.find(m => 
          m.codigo === codigo &&
          m.fabricante.toLowerCase() === fabricante.toLowerCase() &&
          m.modelo.toLowerCase() === modelo.toLowerCase()
        );

        const modelData = {
          codigo,
          fabricante,
          modelo,
          foto,
          paints,
          duplicados: 1
        };

        if (existing) {
          await updateDoc(doc(db, "modelos", existing.id), modelData);
          updated++;
        } else {
          await addDoc(collection(db, "modelos"), modelData);
          imported++;
        }
      }

      alert(`Importaci√≥n finalizada:\n- ${imported} modelos nuevos\n- ${updated} modelos actualizados`);

      // Refrescamos la lista
      await cargarModelos();
      pintar();

    } catch (err) {
      console.error('Error al importar:', err);
      alert('Error al procesar el Excel. Revisa la consola.');
    }
  };
  reader.readAsBinaryString(file);
};
</script>
</body>
</html>
